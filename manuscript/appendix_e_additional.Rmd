
```{r S1_cue_model, echo=FALSE, eval=FALSE}

# S1.full.bm<-brm(correct~condition*z.age+z.trial+sex+(z.trial|subid), 
# table(rep.S1.bayes.data$condition, rep.S1.bayes.data$cue)

S1.cue.model<-brm(correct ~ condition*z.age +z.trial +sex +(z.trial|subid) +(z.age|cue), 
               data= rep.S1.bayes.data, 
               family=bernoulli(),
               chains = 4,
               iter= 2000,
               cores= 4)

S1.cue.model <- add_criterion(S1.cue.model, c("loo", "waic"))


saveRDS(S1.cue.model, "../models/S1.cue.model.rds")

```

```{r S2_cue_model, echo=FALSE, eval=FALSE}


# S1.full.bm<-brm(correct~condition*z.age+z.trial+sex+(z.trial|subid), 
# table(rep.S2.bayes.data$condition, rep.S2.bayes.data$cue)

S2.cue.model<-brm(correct ~ condition*z.age +z.trial +sex +(z.trial|subid) +(z.age|cue), 
               data= rep.S2.bayes.data, 
               family=bernoulli(),
               chains = 4,
               iter= 5000,
               cores= 4)

S2.cue.model <- add_criterion(S2.cue.model, c("loo", "waic"))


saveRDS(S2.cue.model, "../models/S2.cue.model.rds")

```

```{r S3_cue_model, echo=FALSE, eval=FALSE}


# S1.full.bm<-brm(correct~condition*z.age+z.trial+sex+(z.trial|subid), 
# table(rep.S2.bayes.data$condition, rep.S2.bayes.data$cue)

S3.cue.model<-brm(correct ~ condition*z.age +z.trial +sex +(z.trial|subid) +(z.age|cue), 
               data= rep.S3.bayes.data, 
               family=bernoulli(),
               chains = 4,
               iter= 5000,
               cores= 4)

S3.cue.model <- add_criterion(S3.cue.model, c("loo", "waic"))


saveRDS(S3.cue.model, "../models/S3.cue.model.rds")

```

```{r S1S2S3_ppcheck, echo=FALSE, eval=FALSE}
# read in models
S1.cue.model <- readRDS("../models/S1.cue.model.rds")
S1.item.model <- readRDS("../models/S1.item.model.rds")

### POSTERIOR PREDICTICE CHECKS
# cue
pp_check(S1.cue.model)
pp_check(S1.cue.model, type = "bars")
# item
pp_check(S1.item.model)
pp_check(S1.item.model, type = "bars")

summary(S1.cue.model) # Intercept 0.45 .10-.27
summary(S1.item.model) # Intercept  0.17 .01-.40

```

```{r S1S2S3_rhat_bulkESS, echo=FALSE, eval=FALSE}

### EFFECTICE SAMPLE SIZES
### inspect rhat --> always 1 --> good
### inspect Bulk_ESS --> always > 1000 --> good
# summary(S1.item.model)

S1.cue.coef <- summarise_draws(as_draws_df(S1.cue.model)) %>%
  filter(grepl("^b_", variable) |
         grepl("^sd_", variable)) %>%
  mutate(variable = gsub("b_", "", variable)) %>%
  mutate(variable = gsub("condition", "", variable)) %>%
  data.frame(row.names = "variable")

S1.item.coef <- summarise_draws(as_draws_df(S1.item.model)) %>%
  filter(grepl("^b_", variable) |
         grepl("^sd_", variable)) %>%
  mutate(variable = gsub("b_", "", variable)) %>%
  mutate(variable = gsub("condition", "", variable)) %>%
  data.frame(row.names = "variable")

# CUE
# all > 1000
mean(S1.cue.coef$ess_bulk)
min(S1.cue.coef$ess_bulk)
max(S1.cue.coef$ess_bulk)
# all = 1  
mean(S1.cue.coef$rhat)
min(S1.cue.coef$rhat)
max(S1.cue.coef$rhat)

# ITEM
# all > 1000
mean(S1.item.coef$ess_bulk)
min(S1.item.coef$ess_bulk)
max(S1.item.coef$ess_bulk)

# all = 1  
mean(S1.item.coef$rhat)
min(S1.item.coef$rhat)
max(S1.item.coef$rhat)


# Cue Intercept beta = `r S1.full.coef["sd_cue__Intercept", "mean"]`,
# 95% CrI [`r S1.full.coef["sd_cue__Intercept", "q5"]`, `r S1.full.coef["sd_cue__Intercept", "q95"]`]

# Cue Type	Log-Odds	Accuracy (%)
# Average cue	        2.10	89.1%
# 1 SD below average	1.65	84.0%
# 1 SD above average	2.55	92.7%


```

```{r S1_illustrationcueintercepts, echo=FALSE, eval=FALSE}

# CUE

# summary(S1.item.model)
cue_effects <- ranef(S1.cue.model)$cue

# Extract random intercepts
cue_intercepts <- as_tibble(cue_effects[, , "Intercept"], rownames = "cue") %>%
  rename(
    estimate = Estimate,
    lower = Q2.5,
    upper = Q97.5) %>% 
  mutate(condition = substr(cue,1,4))


cue.plot <- ggplot(cue_intercepts, aes(x = reorder(cue, estimate), y = estimate, color = condition)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  coord_flip() +
  facet_wrap(~ condition, scales = "free_y", ncol = 1) +
  labs(
    title = "Cue-Level Random Intercepts by Condition",
    x = "Cue",
    y = "Estimated Deviation from Overall Intercept (log-odds)",
    color = "Condition"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",  # Remove if you want a legend
    strip.text = element_text(size = 12, face = "bold")
  )

# summary(S1.item.model)
item_effects <- ranef(S1.item.model)$item

# Extract random intercepts
item_intercepts <- as_tibble(item_effects[, , "Intercept"], rownames = "item") %>%
  rename(
    estimate = Estimate,
    lower = Q2.5,
    upper = Q97.5) %>% 
  mutate(condition = substr(item,1,4))


item.plot <- ggplot(item_intercepts, aes(x = reorder(item, estimate), y = estimate, color = condition)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  coord_flip() +
  facet_wrap(~ condition, scales = "free_y", ncol = 1) +
  labs(
    title = "Item-Level Random Intercepts by Condition",
    x = "Item",
    y = "Estimated Deviation from Overall Intercept (log-odds)",
    color = "Condition"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 12, face = "bold"))


# cue.plot 
# item.plot
library(patchwork)
combined_plot <- cue.plot + item.plot + plot_layout(ncol = 2)

combined_plot

```

```{r objectfeaturecomp, echo=FALSE, eval=FALSE}

objectfeature.data  <- rep.data %>%
  filter(valid != "drop") %>% # valid participants only 
  filter(trial != "fam") %>% 
  filter(cond %in% c("orfe", "orob", "sife", "siob", "nufe", "nuob")) %>% 
  select(condition, cond, subid, sex, aged, correct, trial, rt, cue) %>%
  mutate(z.trial = scale(as.numeric(trial)),
         ageinyears = aged/356.25, 
         z.age = ageinyears - mean(ageinyears),
         z.sex = scale(as.numeric(sex)),
         objectfeature = case_when(
           grepl("ob", cond) ~ "object",
           grepl("fe", cond) ~ "feature",
           TRUE ~ NA_character_))

table(objectfeature.data$condition)
table(objectfeature.data$objectfeature)

perc_objectfeature.data <- objectfeature.data %>% 
  group_by(objectfeature) %>% 
  summarize(mean = mean(correct))

perc_objectfeature.data

```

```{r roundangularcomp, echo=FALSE, eval=FALSE}


rep.S1.shape.data  <- rep.data %>%
  filter(valid != "drop") %>% # valid participants only 
  filter(study == "study1") %>% # in study one
  filter(trial != "fam") %>% 
  select(condition, subid, sex, aged, correct, trial, rt, cue) %>%
  mutate(z.trial = scale(as.numeric(trial)),
         ageinyears = aged/356.25, 
         z.age = ageinyears - mean(ageinyears),
         z.sex = scale(as.numeric(sex)),
         shape = case_when(
           grepl("A", cue) ~ "round",
           grepl("B", cue) ~ "angular",
           TRUE ~ NA_character_))

# shape    mean
# <chr>   <dbl>
#   1 angular 0.709
# 2 round   0.709

# :- D

perc_rep.S1.shape.data <- rep.S1.shape.data %>% 
  group_by(condition, shape) %>% 
  summarize(mean = mean(correct))

perc_rep.S1.shape.data

```

# Appendix E - Additional Analyses 

Preregistration: An additional exploratory analysis will include a random effect for item level effects (Model: correct ~ task*z.age +z.trial +z.sex +(z.trial|id) +(z.age|item)). Results will help to evaluate the equivalence of items within a task and be reported in the supplements.

**correct ~ condition*z.age +z.trial +sex +(z.trial|subid) +(z.age|cue)**

Cue Level Models

## Study 1
Additional Tables and illustrations for the convenience of the reader. Add illustrations they said; it will add value they said.

## Study 2
Additional Tables and illustrations for the convenience of the reader. Add illustrations they said; it will add value they said.

## Study 3
Additional Tables and illustrations for the convenience of the reader. Add illustrations they said; it will add value they said.
