---
title             : "SUPPLEMENTARY MATERIAL for DOIXXXXXXXXXX"
shorttitle        : "Supplementary Material"
author: 
  - name          : "Gregor Kachel"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "Universitätsallee 1, C1.008a, 21335 Lüneburg"
    email         : "gregor.kachel&#64;leuphana.de"
  - name          : "Daniel Haun"
    affiliation   : "2"
  - name          : "Manuel Bohn"
    affiliation   : "1"
affiliation:
  - id            : "1"
    institution   : "Leuphana University"
  - id            : "2"
    institution   : "Max-Planck-Institute for Evolutionary Anthropology"

wordcount         : "XXX"
bibliography      : ["library.bib"]
floatsintext      : no
linenumbers       : yes
draft             : no
mask              : no
figurelist        : no
tablelist         : no
footnotelist      : no
output:
  papaja::apa6_doc: default
    
editor_options: 
  markdown: 
    wrap: 72
---

<!-- Packages, Setup, Read data for all studies, and prepare for analyses -->

```{r setup, include = FALSE}
library("papaja")
r_refs("library.bib")

# NOTE; how to push title, authornotes and abstract 
# note: "\\clearpage"


# Loading packages 
# NOTE: this will install these packages in case they are missing

# General
if (!require(tidyverse)) install.packages('tidyverse'); library(tidyverse)
if (!require(lsr)) install.packages('lsr'); library(lsr) # Analysis, Cohen's D
if (!require(ggthemes)) install.packages('ggthemes'); library(ggthemes) # for tufte boxplots
# if (!require(kableExtra)) install.packages('kableExtra'); library(kableExtra) 

# plotting graphic
library(patchwork)
library(cowplot)
library(magick)

# Styling library(flextable)
if (!require(flextable)) install.packages('flextable'); library(flextable) 

# bayes packages
if (!require(brms)) install.packages('brms'); library(brms) # 
if (!require(tidybayes)) install.packages('tidybayes'); library(tidybayes) # 
if (!require(HDInterval)) install.packages('HDInterval'); library(HDInterval) # 
if (!require(posterior)) install.packages('posterior'); library(posterior) # 

# basic analyses
if (!require(scales)) install.packages('scales'); library(scales) # 

# plotting
## ggplot via tidyverse
if (!require(cowplot)) install.packages('cowplot'); library(cowplot) # 
if (!require(png)) install.packages('png'); library(png) # 
if (!require(grid)) install.packages('grid'); library(grid) # 

# Troubleshooting Knitting Document
# might be required for knitting manuscript
# install.packages('tinytex')
# tinytex::install_tinytex()
# 
# tinytex::tlmgr_update()
# tinytex::reinstall_tinytex()

# Seed for random number generation
set.seed(42)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)


```

```{r rep_read_data, include = FALSE}

# Full data set including all participants (i.e. including dropped participants)
rep.data <- readRDS("../data/symlitrep_final_data.rds")

# test  <- rep.data %>%
#   #filter(valid != "drop") %>% # valid participants only 
#   filter(trial != "fam") %>% 
#   group_by(subid, agem) %>% 
#   summarize(participants = n_distinct(subid),
#             trials = n())

# Study1 
rep.S1.bayes.data  <- rep.data %>%
  filter(valid != "drop") %>% # valid participants only 
  filter(study == "study1") %>% # in study one
  filter(trial != "fam") %>% 
  select(condition, subid, sex, aged, agey, agem, correct, trial, rt, cue) %>%
  mutate(condition = factor(condition, levels = c(
        "Representation", # first level becomes reference
        "Pars Pro Toto", 
        "Simple Form Analogy", 
        "Complex Form Analogy"))) %>%  
  mutate(sex = factor(sex, levels = c(
        "0", # first level becomes reference
        "1"))) %>%  
  mutate(z.trial = scale(as.numeric(trial)),
         ageinyears = aged/365.25, 
         z.age = ageinyears - mean(ageinyears),
         z.sex = scale(as.numeric(sex))) %>% 
  mutate(item = gsub("_A.png", "", cue)) %>% 
  mutate(item = gsub("_B.png", "", item)) 

# Study2
rep.S2.bayes.data  <- rep.data %>%
  filter(valid != "drop") %>% # valid participants only 
  filter(study == "study2") %>% # in study two
  filter(trial != "fam") %>% 
  select(condition, subid, sex, aged, agey, agem, correct, trial, rt, cue) %>%
  mutate(condition = factor(condition, levels = c(
        "Absolute Position", # first level becomes reference
        "Relative Position", 
        "Orientation of Object", 
        "Orientation of Feature"))) %>%  
  mutate(sex = factor(sex, levels = c(
        "0", # first level becomes reference
        "1"))) %>%  
  mutate(z.trial = scale(as.numeric(trial)),
         ageinyears = aged/365.25, 
         z.age = ageinyears - mean(ageinyears),
         z.sex = scale(as.numeric(sex))) %>% 
  mutate(item = gsub("_A.png", "", cue)) %>% 
  mutate(item = gsub("_B.png", "", item)) 

# Study 3 
rep.S3.bayes.data  <- rep.data %>%
  filter(valid != "drop") %>% # valid participants only 
  filter(study == "study3") %>% # in study two
  filter(trial != "fam") %>% 
  select(condition, subid, sex, aged, agey, agem, correct, trial, rt, cue) %>%
  mutate(condition = factor(condition, levels = c(
        "Size of Object", # first level becomes reference
        "Size of Feature", 
        "Number of Object", 
        "Number of Feature"))) %>%  
  mutate(sex = factor(sex, levels = c(
        "0", # first level becomes reference
        "1"))) %>%  
  mutate(z.trial = scale(as.numeric(trial)),
         ageinyears = aged/365.25, 
         z.age = ageinyears - mean(ageinyears),
         z.sex = scale(as.numeric(sex))) %>% 
  mutate(item = gsub("_A.png", "", cue)) %>% 
  mutate(item = gsub("_B.png", "", item)) 

# test <- rep.data %>%
#   filter(valid != "drop") %>%
#   group_by(study) %>%
#   summarize(min_Age = min(agem))

# test <- rep.data %>% 
#   filter(valid != "drop") %>% 
#   group_by(study, condition) %>% 
#   summarize(N = length(subid))


```

```{r S1S2s3_colours, echo=FALSE, eval=T}
#
add_colour <- function(df) {
  df %>%
    mutate(colour = case_when(
      condition == "Representation" ~ "#00441b",
      condition == "Pars Pro Toto" ~ "#238b45",
      condition == "Simple Form Analogy" ~ "#cc4c02",
      condition == "Complex Form Analogy" ~ "#ff9609",
      condition == "Absolute Position" ~ "#084081",
      condition == "Relative Position" ~ "#2b8cbe",
      condition == "Orientation of Object" ~ "#7B3F00",
      condition == "Orientation of Feature" ~ "#B55239",
      condition == "Size of Object" ~ "#2E004F", 
      condition == "Size of Feature" ~ "#9370DB",
      condition == "Number of Object" ~ "#67000d",
      condition == "Number of Feature" ~ "#cb181d",
      TRUE ~ NA_character_
    ))
}

# condition_colours_df <- data.frame(
#   condition = c(
#     # study1
#     "Representation", 
#     "Pars Pro Toto", 
#     "Simple Form Analogy", 
#     "Complex Form Analogy",
#     # study 2
#     "Absolute Position", 
#     "Relative Position", 
#     "Orientation of Object", 
#     "Orientation of Feature",
#     # study3
#     "Size of Object", 
#     "Size of Feature",
#     "Number of Object", 
#     "Number of Feature"),
#   colour = c(
#     # study1
#     "#006400", "#79e000", "#ff9609", "#ffc512",
#     # study2
#     "#4B0082", "#6A5ACD", "#8B0000", "#A0522D",
#     # study3
#     "#191970", "#008080", "#800080", "#8B008B"
#   ),
#   stringsAsFactors = F
# )
# 
# # Function to add colour using left_join
# add_colour <- function(df) {
#   df %>% 
#     left_join(condition_colours_df, by = "condition")
# }

# condition_colours <- c(
#   "Representation" = "#006400",  # Dark Green
#   "Pars Pro Toto" = "#79e000",    # Forest Green
#   "Simple Form Analogy" = "#ff9609",  
#   "Complex Form Analogy" = "#ffc512", 
#   "Absolute Position" = "#4B0082",    # Indigo (dark purple)
#   "Relative Position" = "#6A5ACD",    # Slate Blue
#   "Orientation of Object" = "#8B0000", # Dark Red
#   "Orientation of Feature" = "#A0522D", # Sienna (dark orange-brown)
#   "Size of Object" = "#191970",        # Midnight Blue
#   "Size of Feature" = "#008080",       # Teal
#   "Number of Object" = "#800080",      # Purple
#   "Number of Feature" = "#8B008B"       # Dark Magenta
# )

```

<!-- Prepare Demographics -->

```{r S1S2s3_participant_demographics, echo=F, eval=T}

rep.age.table.data  <- rep.data %>% 
  distinct(subid, .keep_all = TRUE) %>% # select only one line per participant
  filter(valid != "drop") %>%  # filter out dropped participants
  group_by(study) %>% 
  summarize(
    N = length(subid),
    female = sum(sex=="0"),
    Mean = mean(agem),
    Min = min(agem),
    Max = max(agem),
    SD = round(sd(agem), 2),
    N_daycare = length(subid[where == "daycare"]),
    N_lab = length(subid[where == "lab"]),
    N_home = length(subid[where == "home"]),
    N_hort = length(subid[where == "afterschoolcenter"]))

rep.age.table.data <- data.frame(rep.age.table.data, row.names = "study")

rep.drop.table.data  <- rep.data %>%
  distinct(subid, .keep_all = TRUE) %>% # select only one line per participant
  filter(valid == "drop") %>%
  group_by(study) %>%
  summarize(
    N = length(subid),
    female = sum(sex=="0"),
    Mean = mean(agem),
    Min = min(agem),
    Max = max(agem),
    fail_in_fam = length(subid[drop == "fail_in_fam"]),
    quit_early = length(subid[drop == "quit_early"]),
    fussy_child = length(subid[drop == "fussy_child"]),
    language = length(subid[drop == "language"]),
    technical = length(subid[drop == "technical"]))

rep.drop.table.data <- data.frame(rep.drop.table.data, row.names = "study")

# Count trials by conditions
rep.s1.trials <- rep.S1.bayes.data %>% 
  group_by(condition) %>% 
  summarize(
    Trials = n(),                
    N = n_distinct(subid))

rep.s2.trials <- rep.S2.bayes.data %>% 
  group_by(condition) %>% 
  summarize(
    Trials = n(),                
    N = n_distinct(subid))

rep.s3.trials <- rep.S3.bayes.data %>% 
  group_by(condition) %>% 
  summarize(
    Trials = n(),                
    N = n_distinct(subid))

```

```{r plot-participants-dots, echo = F, warning=F}

age.plot.data <- rep.data %>% #select data
  distinct(subid, .keep_all = TRUE) %>% # select only one line per participant
  filter(valid != "drop")  %>%
  mutate(sex = as.factor(sex))  %>%
  mutate(sex = fct_recode(sex, "female" = "0","male"="1")) %>% 
  rename(Sex = sex) %>% 
  mutate(study = case_when(
    study == "study1" ~ "Study 1",
    study == "study2" ~ "Study 2",
    study == "study3" ~ "Study 3",
    TRUE ~ NA_character_))

age.plot <- ggplot(age.plot.data, aes(x = agem, fill = Sex)) +
  geom_dotplot(stackgroups = TRUE, binwidth = 1, binpositions = "all") +  
  coord_fixed(ratio = 4, xlim = c(36, 84), ylim = c(0, 1.01)) +  # combine here
  theme_bw() +
  scale_x_continuous(name = "Age in Months", breaks = seq(36, 84, 12), minor_breaks = seq(36, 84, 1)) +
  scale_y_continuous(name = "Participants", breaks = NULL) +
  facet_wrap(~ study, ncol = 1) +
  labs(fill = NULL) +
  guides(fill = guide_legend(ncol =2, byrow = TRUE)) +  
  theme_minimal() +
  theme(
    base_size = 13,
    panel.grid.minor.x = element_line(linewidth = 0.25, linetype = 2),
    panel.grid.major.x = element_line(linewidth = 1, linetype = 1),
    panel.border = element_rect(colour = "grey30", fill = NA, linewidth = 1),
    strip.background = element_rect(colour = "grey30", size = 1),
    strip.text = element_text(face = "bold", size = rel(.9), 
                              margin = margin(t = 5, b = 8)),
    axis.title = element_text(face = "bold", size = rel(.9)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = c(1, -0.06),              
    legend.justification = c(1, 1),
    legend.text = element_text(size = rel(.9)),
    panel.grid.minor = element_blank()
  )

ggsave(
  filename = "../illustrations/plot_supp_participants_S123.png",
  plot = age.plot,
  device = "png",
  width = 9.5, height = 6,
  dpi = 300,
  units = "in",
  bg = "white")
# 
# # display plot
# img <- image_read("../illustrations/plot_participants_S123.png")
# 
# windows(width = 15, height = 10)  # On Windows
# plot(img)



```

```{r plot-exclusions-dots, echo = F, warning=F}

drop.plot.data <- rep.data %>% #select data
  distinct(subid, .keep_all = TRUE) %>% # select only one line per participant
  filter(valid == "drop") %>% 
  mutate(study = case_when(
    study == "study1" ~ "Study 1",
    study == "study2" ~ "Study 2",
    study == "study3" ~ "Study 3",
    TRUE ~ NA_character_)) %>% 
  mutate(drop = case_when(
    drop == "fail_in_fam" ~ "< 75% Correct in Familiarization",
    drop == "fussy_child" ~ "Fussy Child", 
    drop == "language" ~ "Low Language Proficiency", 
    drop == "quit_early" ~ "Quit Early",
    drop == "technical" ~ "Technical Problem",
    TRUE ~ NA_character_)) %>%  
  mutate(drop = factor(drop, levels = c(
    "< 75% Correct in Familiarization",
    "Quit Early",
    "Fussy Child",
    "Low Language Proficiency",
    "Technical Problem")))

drop.plot <- ggplot(drop.plot.data, aes(x = agem, fill = drop)) +
  geom_dotplot(stackgroups = TRUE, binwidth = 1, binpositions = "all") +  
  theme_bw() +
  scale_x_continuous(name = "Age in Months", breaks = seq(36, 84, 12), minor_breaks = seq(36, 84, 1)) +
  scale_y_continuous(name = "Exclusions", breaks = NULL) +
  coord_fixed(ratio = 4, xlim = c(36, 84), ylim = c(0, 1.5)) + 
  facet_wrap(~ study, ncol = 1) +
  labs(fill = NULL) +
  guides(fill = guide_legend(ncol = 5, byrow = TRUE)) +  
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.minor.x = element_line(linewidth = 0.25, linetype = 2),
    panel.grid.major.x = element_line(linewidth = 1, linetype = 1),
    panel.border = element_rect(colour = "grey30", fill = NA, linewidth = 1),
    strip.background = element_rect(colour = "grey30", size = 1),
    strip.text = element_text(face = "bold", size = rel(.9), 
                              margin = margin(t = 5, b = 8)),
    axis.title = element_text(face = "bold", size = rel(.9)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = "bottom",
    legend.justification = c(1, 1),
    legend.text = element_text(size = rel(.9)),
    legend.margin = margin(t = 2),
    plot.margin = margin(10, 10, 10, 10),
    panel.grid.minor = element_blank()
  )

ggsave(
  filename = "../illustrations/plot_supp_exclusions_S123.png",
  plot = drop.plot,
  device = "png",
  width = 9.5, height = 6,
  dpi = 300,
  units = "in",
  bg = "white")


# # display plot
# img <- image_read("../illustrations/plot_supp_exclusions_S123.png")
# 
# windows(width = 15, height = 10)  # On Windows
# plot(img)

```

<!-- Run full and null models for all three studies (not evaluated to save time) -->

```{r rep_s1_bayes, echo = FALSE, include=F, eval=F, results='asis'}

# NOTE: this is section is not evaluated to save time during knitting

# in prergistration we used the term "task" instead of "condition", same thing
# we have now decided to not scale sex to make interpretation more straightforward
# preregistered: correct ~ task*z.age +z.trial +z.sex +(z.trial|id)

S1.full.bm<-brm(correct~condition*z.age+z.trial+sex+(z.trial|subid), 
               data= rep.S1.bayes.data, 
               family=bernoulli(),
               chains = 4,
               iter= 5000,
               cores= 4)

S1.full.bm <- add_criterion(S1.full.bm, c("loo", "waic"))

S1.null.bm<-brm(correct~condition+z.age+z.trial+sex+(z.trial|subid), 
               data= rep.S1.bayes.data, 
               family=bernoulli(),
               chains = 4,
               iter= 5000,
               cores= 4)

S1.null.bm <- add_criterion(S1.null.bm, c("loo", "waic"))

### MODEL COMPARISON
S1.comp <- loo_compare(S1.null.bm, S1.full.bm, criterion = "waic")%>%as_tibble(rownames = "index")
S1.comp <- data.frame(S1.comp, row.names = "index")

S1.weights <- model_weights(S1.null.bm, S1.full.bm, criterion = "waic") 
S1.weights <- S1.weights %>% as_tibble(rownames = "index")
S1.weights <- data.frame(S1.weights, row.names = "index")

# "significant" if elpd_diff > 2*se_diff (confer Sivula et al., 2020)

### LOO COMPARISON
### not reported, essentially identical
# S1.null.loo <- loo(S1.null.bm)
# S1.full.loo <- loo(S1.full.bm)
# S1.loo.comp <- loo_compare(S1.null.loo, S1.full.loo) %>%
#   as_tibble(rownames = "model")
# S1.loo.comp

# Saving the model (to not rerun it every time)
saveRDS(S1.full.bm, "../models/S1.full.bm.rds")
saveRDS(S1.null.bm, "../models/S1.null.bm.rds")
saveRDS(S1.comp, "../models/S1.comp.rds")
saveRDS(S1.weights, "../models/S1.weights.rds")

```

```{r rep_s2_bayes, echo = FALSE, include=F, eval=F, results='asis'}

# NOTE: this is section is not evaluated to save time during knitting

# in prergistration we used the term "task" instead of "condition", same thing
# we have now decided to not scale sex to make interpretation more straightforward
# preregistered: correct ~ task*z.age +z.trial +z.sex +(z.trial|id)

S2.full.bm<-brm(correct~condition*z.age+z.trial+sex+(z.trial|subid), 
                data= rep.S2.bayes.data, 
                family=bernoulli(),
                chains = 4,
                iter= 5000,
                cores= 4)

S2.full.bm <- add_criterion(S2.full.bm, c("loo", "waic"))

S2.null.bm<-brm(correct~condition+z.age+z.trial+sex+(z.trial|subid), 
                data= rep.S2.bayes.data, 
                family=bernoulli(),
                chains = 4,
                iter= 5000,
                cores= 4)

S2.null.bm <- add_criterion(S2.null.bm, c("loo", "waic"))

### MODEL COMPARISON
S2.comp <- loo_compare(S2.null.bm, S2.full.bm, criterion = "waic")%>%as_tibble(rownames = "index")
S2.comp <- data.frame(S2.comp, row.names = "index")


S2.weights <- model_weights(S2.null.bm, S2.full.bm, criterion = "waic") 
S2.weights <- S2.weights %>% as_tibble(rownames = "index")
S2.weights <- data.frame(S2.weights, row.names = "index")


# "significant" if elpd_diff > 2*se_diff (confer Sivula et al., 2020)

### LOO COMPARISON
### not reported, essentially identical
# S2.null.loo <- loo(S2.null.bm)
# S2.full.loo <- loo(S2.full.bm)
# S2.loo.comp <- loo_compare(S2.null.loo, S2.full.loo) %>%
#   as_tibble(rownames = "model")
# S2.loo.comp

# Saving the model (to not rerun it every time)
saveRDS(S2.full.bm, "../models/S2.full.bm.rds")
saveRDS(S2.null.bm, "../models/S2.null.bm.rds")
saveRDS(S2.comp, "../models/S2.comp.rds")
saveRDS(S2.weights, "../models/S2.weights.rds")

### item level model
# S2.item.bm<-brm(correct~condition+z.age+z.trial+z.sex+(z.trial|subid)+ (z.age|item), 
#                data= rep.S2.bayes.data, 
#                family=bernoulli(),
#                chains = 4,
#                iter= 2000,
#                cores= 4)

```

```{r rep_s3_bayes, echo = FALSE, include=F, eval=F, results='asis'}



# NOTE: this is section is not evaluated to save time during knitting

# in prergistration we used the term "task" instead of "condition", same thing
# we have now decided to not scale sex to make interpretation more straightforward
# preregistered: correct ~ task*z.age +z.trial +z.sex +(z.trial|id)

S3.full.bm<-brm(correct~condition*z.age+z.trial+sex+(z.trial|subid), 
                data= rep.S3.bayes.data, 
                family=bernoulli(),
                chains = 4,
                iter= 5000,
                cores= 4)

S3.full.bm <- add_criterion(S3.full.bm, c("loo", "waic"))

S3.null.bm<-brm(correct~condition+z.age+z.trial+sex+(z.trial|subid), 
                data= rep.S3.bayes.data, 
                family=bernoulli(),
                chains = 4,
                iter= 5000,
                cores= 4)

S3.null.bm <- add_criterion(S3.null.bm, c("loo", "waic"))

### MODEL COMPARISON
S3.comp <- loo_compare(S3.null.bm, S3.full.bm, criterion = "waic")%>%as_tibble(rownames = "index")
S3.comp <- data.frame(S3.comp, row.names = "index")


S3.weights <- model_weights(S3.null.bm, S3.full.bm, criterion = "waic") 
S3.weights <- S3.weights %>% as_tibble(rownames = "index")
S3.weights <- data.frame(S3.weights, row.names = "index")




# "significant" if elpd_diff > 2*se_diff (confer Sivula et al., 2020)

### LOO COMPARISON
### not reported, essentially identical
# S3.null.loo <- loo(S3.null.bm)
# S3.full.loo <- loo(S3.full.bm)
# S3.loo.comp <- loo_compare(S3.null.loo, S3.full.loo) %>%
#   as_tibble(rownames = "model")
# S3.loo.comp

# Saving the model (to not rerun it every time)
saveRDS(S3.full.bm, "../models/S3.full.bm.rds")
saveRDS(S3.null.bm, "../models/S3.null.bm.rds")
saveRDS(S3.comp, "../models/S3.comp.rds")
saveRDS(S3.weights, "../models/S3.weights.rds")

### item level model
# S3.item.bm<-brm(correct~condition+z.age+z.trial+z.sex+(z.trial|subid)+ (z.age|item), 
#                data= rep.S3.bayes.data, 
#                family=bernoulli(),
#                chains = 4,
#                iter= 2000,
#                cores= 4)




```

<!-- Diagnostics for all three studies -->

```{r rep_s1_inspect, echo = FALSE, include=F, eval=T, results='asis'}

S1.full.bm <- readRDS("../models/S1.full.bm.rds")
S1.null.bm <- readRDS("../models/S1.null.bm.rds")

S1.comp <- readRDS("../models/S1.comp.rds")
S1.weights <- readRDS("../models/S1.weights.rds")

### POSTERIOR PREDICTICE CHECKS
### Check plots ...they look good, as expected in binomial models
# pp_check(S1.full.bm)
# pp_check(S1.null.bm)
# pp_check(S1.full.bm, type = "bars")
# pp_check(S1.null.bm, type = "bars")

### EFFECTICE SAMPLE SIZES
### inspect rhat --> always 1 --> good
### inspect Bull_ESS --> always > 1000 --> good
# summary(S1.full.bm)
# summary(S1.null.bm)

# for reporting BULK_ESS and Coefficients
S1.full.coef <- summarise_draws(as_draws_df(S1.full.bm)) # ! standard is just 90% CrI

# NOTE: # as_draws_df() from posterior uses 90% CrIs
# we preregistered using 2.5% and 97.5% quantiles
draws_df <- as_draws_df(S1.full.bm)
quantiles_df <- as.data.frame(t(apply(draws_df, 2, quantile, probs = c(0.025, 0.975))))
quantiles_df <- tibble::rownames_to_column(quantiles_df, var = "variable")
names(quantiles_df)[2:3] <- c("q2.5", "q97.5")

S1.full.coef <- left_join(S1.full.coef, quantiles_df, by = "variable") 

# for table in appendix:
S1.full.coef.table <- S1.full.coef

# for reporting in text:
S1.full.coef <- S1.full.coef %>% 
  filter(grepl("^b_", variable)) %>% 
  mutate(variable = gsub("b_", "", variable)) %>% 
  mutate(variable = gsub("condition", "", variable)) %>% 
  data.frame(row.names = "variable")

S1.null.coef <- summarise_draws(as_draws_df(S1.null.bm)) %>%
  filter(grepl("^b_", variable))
# 
# mean(S1.full.coef$ess_bulk)
# min(S1.full.coef$ess_bulk)
# max(S1.full.coef$ess_bulk)
# 
# mean(S1.null.coef$ess_bulk)
# min(S1.null.coef$ess_bulk)
# max(S1.null.coef$ess_bulk)


```

```{r rep_s2_inspect, echo = FALSE, include=F, eval=T, results='asis'}

S2.full.bm <- readRDS("../models/S2.full.bm.rds")
S2.null.bm <- readRDS("../models/S2.null.bm.rds")

S2.comp <- readRDS("../models/S2.comp.rds")
S2.weights <- readRDS("../models/S2.weights.rds")


### POSTERIOR PREDICTICE CHECKS
### Check plots ...they look good, as expected in binomial models
# pp_check(S2.full.bm)
# pp_check(S2.null.bm)
# pp_check(S2.full.bm, type = "bars")
# pp_check(S2.null.bm, type = "bars")

### EFFECTICE SAMPLE SIZES
### inspect rhat --> always 1 --> good
### inspect Bull_ESS --> always > 1000 --> good
# summary(S2.full.bm)
# summary(S2.null.bm)

# # for reporting BULK_ESS
# S2.full.coef <- summarise_draws(as_draws_df(S2.full.bm)) %>%
#   filter(grepl("^b_", variable)) %>% 
#   mutate(variable = gsub("b_", "", variable)) %>% 
#   mutate(variable = gsub("condition", "", variable)) %>% 
#   data.frame(row.names = "variable")

# for reporting BULK_ESS and Coefficients
S2.full.coef <- summarise_draws(as_draws_df(S2.full.bm)) # ! standard is just 90% CrI

# NOTE: # as_draws_df() from posterior uses 90% CrIs
# we preregistered using 2.5% and 97.5% quantiles
draws_df <- as_draws_df(S2.full.bm)
quantiles_df <- as.data.frame(t(apply(draws_df, 2, quantile, probs = c(0.025, 0.975))))
quantiles_df <- tibble::rownames_to_column(quantiles_df, var = "variable")
names(quantiles_df)[2:3] <- c("q2.5", "q97.5")

S2.full.coef <- left_join(S2.full.coef, quantiles_df, by = "variable") 

# for table in appendix:
S2.full.coef.table <- S2.full.coef

# for reporting in text:
S2.full.coef <- S2.full.coef %>% 
  filter(grepl("^b_", variable)) %>% 
  mutate(variable = gsub("b_", "", variable)) %>% 
  mutate(variable = gsub("condition", "", variable)) %>% 
  data.frame(row.names = "variable")

# NULL MODEL
S2.null.coef <- summarise_draws(as_draws_df(S2.null.bm)) %>%
  filter(grepl("^b_", variable))

# 
# mean(S2.full.coef$ess_bulk)
# min(S2.full.coef$ess_bulk)
# max(S2.full.coef$ess_bulk)
# 
# mean(S2.null.coef$ess_bulk)
# min(S2.null.coef$ess_bulk)
# max(S2.null.coef$ess_bulk)


```

```{r rep_s3_inspect, echo = FALSE, include=F, eval=T, results='asis'}


S3.full.bm <- readRDS("../models/S3.full.bm.rds")
S3.null.bm <- readRDS("../models/S3.null.bm.rds")

S3.comp <- readRDS("../models/S3.comp.rds") 
S3.weights <- readRDS("../models/S3.weights.rds")


## POSTERIOR PREDICTICE CHECKS
## Check plots ...they look good, as expected in binomial models
# pp_check(S3.full.bm)
# pp_check(S3.null.bm)
# pp_check(S3.full.bm, type = "bars")
# pp_check(S3.null.bm, type = "bars")

# ### EFFECTICE SAMPLE SIZES
# ## inspect rhat --> always 1 --> good
# ## inspect Bull_ESS --> always > 1000 --> good
# summary(S3.full.bm)
# summary(S3.null.bm)

# # for reporting BULK_ESS
# S3.full.coef <- summarise_draws(as_draws_df(S3.full.bm)) %>%
#   filter(grepl("^b_", variable)) %>% 
#   mutate(variable = gsub("b_", "", variable)) %>% 
#   mutate(variable = gsub("condition", "", variable)) %>% 
#   data.frame(row.names = "variable")

# for reporting BULK_ESS and Coefficients
S3.full.coef <- summarise_draws(as_draws_df(S3.full.bm)) # ! standard is just 90% CrI

# NOTE: # as_draws_df() from posterior uses 90% CrIs
# we preregistered using 2.5% and 97.5% quantiles
draws_df <- as_draws_df(S3.full.bm)
quantiles_df <- as.data.frame(t(apply(draws_df, 2, quantile, probs = c(0.025, 0.975))))
quantiles_df <- tibble::rownames_to_column(quantiles_df, var = "variable")
names(quantiles_df)[2:3] <- c("q2.5", "q97.5")

S3.full.coef <- left_join(S3.full.coef, quantiles_df, by = "variable") 

# for table in appendix:
S3.full.coef.table <- S3.full.coef

# for reporting in text:
S3.full.coef <- S3.full.coef %>% 
  filter(grepl("^b_", variable)) %>% 
  mutate(variable = gsub("b_", "", variable)) %>% 
  mutate(variable = gsub("condition", "", variable)) %>% 
  data.frame(row.names = "variable")

# NULL MODEL
S3.null.coef <- summarise_draws(as_draws_df(S3.null.bm)) %>%
  filter(grepl("^b_", variable))

# mean(S3.full.coef$ess_bulk)
# min(S3.full.coef$ess_bulk)
# max(S3.full.coef$ess_bulk)
# 
# mean(S3.null.coef$ess_bulk)
# min(S3.null.coef$ess_bulk)
# max(S3.null.coef$ess_bulk)


```

<!-- Prepare Data for Plotting -->

```{r rep_S1_bayes_fullmodel_prep_prepplotting, echo=FALSE, eval=T, warning = F, message=F}

# load model from rds
# S1.full.bm <- readRDS("../models/S1.full.bm.rds")
# table(rep.S1.bayes.data$condition)

nd1 <- tibble(z.age = rep(seq(from = min(rep.S1.bayes.data$z.age), to = max(rep.S1.bayes.data$z.age), length.out = 50),4),
             condition = c(rep("Representation",50), 
                           rep("Pars Pro Toto",50), 
                           rep("Complex Form Analogy",50), 
                           rep("Simple Form Analogy",50)), 
             # the four conditions in the data
             sex = rep(0,200),
             z.trial = rep(0,200))

# here we generate the fitted values based on the model
# the function fitted() takes in the model and the new dataset and generates a fitted values (inclucing upper and lower 95% CrI) for every row in the dataset
# because our dataset ranges from min age to max age in the data, we get the prediction for the age range in the data 
# but we could also generate predictions for different ages of course
f1 <- fitted(S1.full.bm, 
             newdata = nd1, 
             re_formula = NA) %>% 
  # this tells the function to ignore the random effects - in theory, we could generate predictions for specific individuals
  as_tibble() %>%
  bind_cols(nd1)%>%
  mutate(age = z.age + mean(rep.S1.bayes.data$ageinyears)) %>% # convert age back to the original scale by adding the mean of the data
  mutate(condition = factor(condition, levels = c(
        "Representation",
        "Pars Pro Toto", 
        "Simple Form Analogy", 
        "Complex Form Analogy")))

# summarize the data to include them in the plot later on
d1 <- rep.S1.bayes.data%>%
  group_by(subid, ageinyears, condition)%>%
  summarise(mean = mean(correct)) %>% 
  mutate(condition = factor(condition, levels = c(
        "Representation", # first level becomes reference
        "Pars Pro Toto", 
        "Simple Form Analogy", 
        "Complex Form Analogy")))

p1 <- f1 %>%
  mutate(age = age * 365.25) %>%
   mutate(condition = factor(condition, levels = c(
        "Representation", # first level becomes reference
        "Pars Pro Toto", 
        "Simple Form Analogy", 
        "Complex Form Analogy"))) %>% 
  group_by(condition)%>%
  summarise(
    Q2.5_closest_to.5 = Q2.5[which.min(abs(Q2.5-.5))],
    estimate_closest_to.5 = Estimate[which.min(abs(Q2.5-.5))],
    days = age[which.min(abs(Q2.5-.5))],
    months = round(days/30.5),
    years = round(days/365.25, 2),
    monthlabels = as.character(paste(months, "months"))
    )


nd1 <- add_colour(nd1)
f1  <- add_colour(f1)
d1  <- add_colour(d1)
p1  <- add_colour(p1)



```

```{r rep_S2_bayes_fullmodel_prep_prepplotting, echo=FALSE, eval=T, warning = F, message=F}

# load model from rds
S2.full.bm <- readRDS("../models/S2.full.bm.rds")
# table(rep.S2.bayes.data$condition)

nd2 <- tibble(z.age = rep(seq(from = min(rep.S2.bayes.data$z.age), to = max(rep.S2.bayes.data$z.age), length.out = 50),4),
              condition = c(rep("Relative Position",50), 
                            rep("Absolute Position",50), 
                            rep("Orientation of Feature",50), 
                            rep("Orientation of Object",50)),
              sex = rep(0,200),
              z.trial = rep(0,200))

# here we generate the fitted values based on the model
# the function fitted() takes in the model and the new dataset and generates a fitted values (inclucing upper and lower 95% CrI) for every row in the dataset
# because our dataset ranges from min age to max age in the data, we get the prediction for the age range in the data 
# but we could also generate predictions for different ages of course
f2 <- fitted(S2.full.bm, 
             newdata = nd2, 
             re_formula = NA) %>% 
  # this tells the function to ignore the random effects - in theory, we could generate predictions for specific individuals
  as_tibble() %>%
  bind_cols(nd2)%>%
  mutate(age = z.age + mean(rep.S2.bayes.data$ageinyears)) %>% # convert age back to the original scale by adding the mean of the data
  mutate(condition = factor(condition, levels = c(
    "Absolute Position", # first level becomes reference
    "Relative Position", 
    "Orientation of Object", 
    "Orientation of Feature")))

# summarize the data to include them in the plot later on
d2 <- rep.S2.bayes.data%>%
  group_by(subid, ageinyears, condition)%>%
  summarise(mean = mean(correct)) %>% 
  mutate(condition = factor(condition, levels = c(
    "Absolute Position", # first level becomes reference
    "Relative Position", 
    "Orientation of Object", 
    "Orientation of Feature")))

p2 <- f2 %>%
  mutate(age = age * 365.25)%>%
  mutate(condition = factor(condition, levels = c(
    "Absolute Position", # first level becomes reference
    "Relative Position", 
    "Orientation of Object", 
    "Orientation of Feature"))) %>% 
  group_by(condition)%>%
  summarise(
    Q2.5_closest_to.5 = Q2.5[which.min(abs(Q2.5-.5))],
    estimate_closest_to.5 = Estimate[which.min(abs(Q2.5-.5))],
    days = age[which.min(abs(Q2.5-.5))],
    months = round(days/30.5),
    years = round(days/365.25, 2),
    monthlabels = as.character(paste(months, "months"))
  )

nd2 <- add_colour(nd2)
f2  <- add_colour(f2)
d2  <- add_colour(d2)
p2  <- add_colour(p2)

```

```{r rep_S3_bayes_fullmodel_prep_prepplotting, echo=FALSE, eval=T, warning = F, message=F}


# load model from rds
S3.full.bm <- readRDS("../models/S3.full.bm.rds")
# table(rep.S3.bayes.data$condition)

nd3 <- tibble(z.age = rep(seq(from = min(rep.S3.bayes.data$z.age), to = max(rep.S3.bayes.data$z.age), length.out = 50),4),
              condition = c(rep("Number of Object",50), 
                            rep("Number of Feature",50), 
                            rep("Size of Object",50), 
                            rep("Size of Feature",50)),
              sex = rep(0,200),
              z.trial = rep(0,200))

# here we generate the fitted values based on the model
# the function fitted() takes in the model and the new dataset and generates a fitted values (inclucing upper and lower 95% CrI) for every row in the dataset
# because our dataset ranges from min age to max age in the data, we get the prediction for the age range in the data 
# but we could also generate predictions for different ages of course
f3 <- fitted(S3.full.bm, 
             newdata = nd3, 
             re_formula = NA) %>% 
  # this tells the function to ignore the random effects - in theory, we could generate predictions for specific individuals
  as_tibble() %>%
  bind_cols(nd3)%>%
  mutate(age = z.age + mean(rep.S3.bayes.data$ageinyears)) %>% # convert age back to the original scale by adding the mean of the data
  mutate(condition = factor(condition, levels = c(
    "Size of Object", # first level becomes reference
    "Size of Feature", 
    "Number of Object", 
    "Number of Feature")))

# summarize the data to include them in the plot later on
d3 <- rep.S3.bayes.data%>%
  group_by(subid, ageinyears, condition)%>%
  summarise(mean = mean(correct)) %>% 
  mutate(condition = factor(condition, levels = c(
    "Size of Object", # first level becomes reference
    "Size of Feature", 
    "Number of Object", 
    "Number of Feature")))

p3 <- f3 %>%
  mutate(age = age * 365.25)%>%
  mutate(condition = factor(condition, levels = c(
    "Size of Object", # first level becomes reference
    "Size of Feature", 
    "Number of Object", 
    "Number of Feature"))) %>% 
  group_by(condition)%>%
  summarise(
    Q2.5_closest_to.5 = Q2.5[which.min(abs(Q2.5-.5))],
    estimate_closest_to.5 = Estimate[which.min(abs(Q2.5-.5))],
    days = age[which.min(abs(Q2.5-.5))],
    months = round(days/30.5),
    years = round(days/365.25, 2),
    monthlabels = as.character(paste(months, "months"))
  )

nd3 <- add_colour(nd3)
f3  <- add_colour(f3)
d3  <- add_colour(d3)
p3  <- add_colour(p3)

```

<!-- Plotting with stimuli -->

```{r rep_S1_stim_bayes_fullmodel_plotting_new, echo=FALSE, eval=F, warning = F, message=F}


# load images ###################################

# plotexample Representation.png
image_1 <- image_read(paste0("../illustrations/plotexample ", levels(d1$condition)[1], ".png"))
image_2 <- image_read(paste0("../illustrations/plotexample ", levels(d1$condition)[2], ".png"))
image_3 <- image_read(paste0("../illustrations/plotexample ", levels(d1$condition)[3], ".png"))
image_4 <- image_read(paste0("../illustrations/plotexample ", levels(d1$condition)[4], ".png"))
# stimuli Representation.png
image_1_2 <- image_read(paste0("../illustrations/stimuli ", levels(d1$condition)[1], ".png"))
image_2_2 <- image_read(paste0("../illustrations/stimuli ", levels(d1$condition)[2], ".png"))
image_3_3 <- image_read(paste0("../illustrations/stimuli ", levels(d1$condition)[3], ".png"))
image_4_4 <- image_read(paste0("../illustrations/stimuli ", levels(d1$condition)[4], ".png"))
# create grobs
image_1_grob <- rasterGrob(image_1, interpolate = TRUE)
image_2_grob <- rasterGrob(image_2, interpolate = TRUE)
image_3_grob <- rasterGrob(image_3, interpolate = TRUE)
image_4_grob <- rasterGrob(image_4, interpolate = TRUE)
image_1_2_grob <- rasterGrob(image_1_2, interpolate = TRUE)
image_2_2_grob <- rasterGrob(image_2_2, interpolate = TRUE)
image_3_2_grob <- rasterGrob(image_3_3, interpolate = TRUE)
image_4_2_grob <- rasterGrob(image_4_4, interpolate = TRUE)

# plot 1 #####################
plot1 <- ggplot() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey70", alpha = 0.75) +
  
  geom_point(
    data = d1 %>% filter(condition == levels(condition)[1]),
    aes(x = ageinyears, y = mean, colour = colour),
    alpha = 0.5, shape = 1, size = 2
  ) +
  
  geom_smooth(
    data = f1 %>% filter(condition == levels(condition)[1]),
    aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill = colour, colour = colour),
    stat = "identity", alpha = 0.2, linewidth = 0.8
  ) +
  
  # shape 21 uses both fill (inside) and colour (stroke)
  geom_point(
    data = p1 %>% filter(condition == levels(condition)[1]),
    aes(x = days/365.25, y = 0.5, fill = colour, colour = colour),
    size = 4, shape = 21, stroke = 1
  ) +
  
  # constant black overlay: set outside aes()
  geom_point(
    data = p1 %>% filter(condition == levels(condition)[1]),
    aes(x = days/365.25, y = 0.5),
    fill = "black", colour = "black", size = 0.5, shape = 21, stroke = 1
  ) +
  
  # text: move color/fontface outside aes()
  geom_text(
    data = p1 %>% filter(condition == levels(condition)[1]),
    aes(label = months, x = days/365.25, y = 0.13),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  geom_text(
    data = p1 %>% filter(condition == levels(condition)[1]),
    aes(label = "months", x = days/365.25, y = .31),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  scale_colour_identity() +
  scale_fill_identity() +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  labs(x = "Age", y = "Proportion Correct") +
  coord_cartesian(ylim = c(0, 1), xlim = c(2.7, 7.3)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.border = element_rect(colour = "grey30", fill = NA, size = 1),
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title = element_text(face = "bold", size = rel(0.8)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )


# plot 2 ##################
plot2 <- ggplot() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey70", alpha = 0.75) +
  
  geom_point(
    data = d1 %>% filter(condition == levels(condition)[2]),
    aes(x = ageinyears, y = mean, colour = colour),
    alpha = 0.5, shape = 1, size = 2
  ) +
  
  geom_smooth(
    data = f1 %>% filter(condition == levels(condition)[2]),
    aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill = colour, colour = colour),
    stat = "identity", alpha = 0.2, linewidth = 0.8
  ) +
  
  # shape 21 uses both fill (inside) and colour (stroke)
  geom_point(
    data = p1 %>% filter(condition == levels(condition)[2]),
    aes(x = days/365.25, y = 0.5, fill = colour, colour = colour),
    size = 4, shape = 21, stroke = 1
  ) +
  
  # constant black overlay: set outside aes()
  geom_point(
    data = p1 %>% filter(condition == levels(condition)[2]),
    aes(x = days/365.25, y = 0.5),
    fill = "black", colour = "black", size = 0.5, shape = 21, stroke = 1
  ) +
  
  # text: move color/fontface outside aes()
  geom_text(
    data = p1 %>% filter(condition == levels(condition)[2]),
    aes(label = months, x = days/365.25, y = 0.13),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  geom_text(
    data = p1 %>% filter(condition == levels(condition)[2]),
    aes(label = "months", x = days/365.25, y = .31),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  scale_colour_identity() +
  scale_fill_identity() +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  labs(x = "Age", y = "Proportion Correct") +
  coord_cartesian(ylim = c(0, 1), xlim = c(2.7, 7.3)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.border = element_rect(colour = "grey30", fill = NA, size = 1),
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title = element_text(face = "bold", size = rel(0.8)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )

# plot 3 #########################
plot3 <- ggplot() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey70", alpha = 0.75) +
  
  geom_point(
    data = d1 %>% filter(condition == levels(condition)[3]),
    aes(x = ageinyears, y = mean, colour = colour),
    alpha = 0.5, shape = 1, size = 2
  ) +
  
  geom_smooth(
    data = f1 %>% filter(condition == levels(condition)[3]),
    aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill = colour, colour = colour),
    stat = "identity", alpha = 0.2, linewidth = 0.8
  ) +
  
  # shape 21 uses both fill (inside) and colour (stroke)
  geom_point(
    data = p1 %>% filter(condition == levels(condition)[3]),
    aes(x = days/365.25, y = 0.5, fill = colour, colour = colour),
    size = 4, shape = 21, stroke = 1
  ) +
  
  # constant black overlay: set outside aes()
  geom_point(
    data = p1 %>% filter(condition == levels(condition)[3]),
    aes(x = days/365.25, y = 0.5),
    fill = "black", colour = "black", size = 0.5, shape = 21, stroke = 1
  ) +
  
  # text: move color/fontface outside aes()
  geom_text(
    data = p1 %>% filter(condition == levels(condition)[3]),
    aes(label = months, x = days/365.25, y = 0.13),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  geom_text(
    data = p1 %>% filter(condition == levels(condition)[3]),
    aes(label = "months", x = days/365.25, y = .31),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  scale_colour_identity() +
  scale_fill_identity() +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  labs(x = "Age", y = "Proportion Correct") +
  coord_cartesian(ylim = c(0, 1), xlim = c(2.7, 7.3)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.border = element_rect(colour = "grey30", fill = NA, size = 1),
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title = element_text(face = "bold", size = rel(0.8)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )



# plot 4 #########################
plot4 <- ggplot() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey70", alpha = 0.75) +
  
  geom_point(
    data = d1 %>% filter(condition == levels(condition)[4]),
    aes(x = ageinyears, y = mean, colour = colour),
    alpha = 0.5, shape = 1, size = 2
  ) +
  
  geom_smooth(
    data = f1 %>% filter(condition == levels(condition)[4]),
    aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill = colour, colour = colour),
    stat = "identity", alpha = 0.2, linewidth = 0.8
  ) +
  
  # shape 21 uses both fill (inside) and colour (stroke)
  geom_point(
    data = p1 %>% filter(condition == levels(condition)[4]),
    aes(x = days/365.25, y = 0.5, fill = colour, colour = colour),
    size = 4, shape = 21, stroke = 1
  ) +
  
  # constant black overlay: set outside aes()
  geom_point(
    data = p1 %>% filter(condition == levels(condition)[4]),
    aes(x = days/365.25, y = 0.5),
    fill = "black", colour = "black", size = 0.5, shape = 21, stroke = 1
  ) +
  
  # text: move color/fontface outside aes()
  geom_text(
    data = p1 %>% filter(condition == levels(condition)[4]),
    aes(label = months, x = days/365.25, y = 0.13),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  geom_text(
    data = p1 %>% filter(condition == levels(condition)[4]),
    aes(label = "months", x = days/365.25, y = .31),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  scale_colour_identity() +
  scale_fill_identity() +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  labs(x = "Age", y = "Proportion Correct") +
  coord_cartesian(ylim = c(0, 1), xlim = c(2.7, 7.3)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.border = element_rect(colour = "grey30", fill = NA, size = 1),
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title = element_text(face = "bold", size = rel(0.8)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )



# Combine plots #######################

S1_complete <- ggdraw() +
  draw_plot_label(label = paste(levels(d1$condition)[1]), size = 14, x = 0.015, y = 0.98) +
  draw_plot_label(label = paste(levels(d1$condition)[2]), size = 14, x = 0.275, y = 0.98) +
  draw_plot_label(label = paste(levels(d1$condition)[3]), size = 14, x = 0.45, y = 0.98) +
  draw_plot_label(label = paste(levels(d1$condition)[4]), size = 14, x = 0.68, y = 0.98) +
  draw_plot(image_1_grob, y = 0.77, x = 0.05, width = .2, height = .2) +
  draw_plot(image_2_grob, y = 0.77, x = 0.292, width = .2, height = .2) +
  draw_plot(image_3_grob, y = 0.77, x = 0.541, width = .2, height = .2) +
  draw_plot(image_4_grob, y = 0.77, x = 0.79, width = .2, height = .2) +
  draw_plot(image_1_2_grob, y = 0.47, x = -0.01, width = .32, height = .32) +
  draw_plot(image_2_2_grob, y = 0.47, x =  0.23, width = .32, height = .32) +
  draw_plot(image_3_2_grob, y = 0.47, x =  0.48, width = .32, height = .32) +
  draw_plot(image_4_2_grob, y = 0.47, x =  0.728, width = .32, height = .32) +
  draw_plot(plot1, y = 0, x =  0.01, width = .25, height = .44) +
  draw_plot(plot2, y = 0, x =  0.25, width = .25, height = .44) +
  draw_plot(plot3, y = 0, x =  0.5, width = .25, height = .44) +
  draw_plot(plot4, y = 0, x =  0.75, width = .25, height = .44) +
  draw_plot_label(label = "A", size = 14, x = 0, y = 0.89) +
  draw_plot_label(label = "B", size = 14, x = 0, y = 0.65) +
  draw_plot_label(label = "C", size = 14, x = 0, y = 0.26)

# saving images ###############################

ggsave(
  filename = "../illustrations/S1_complete.pdf",
  plot = S1_complete,
  width = 27,
  height = 16.9,
  units = "cm",
  dpi = 600)

# shell.exec("../illustrations/S1_complete.pdf")

ggsave(
  filename = "./../illustrations/S1_complete.jpg",
  plot = S1_complete,
  width = 27,
  height = 16.9,
  units = "cm",
  dpi = 600)

ggsave(
  filename = "./../illustrations/S1_complete.png",
  plot = S1_complete,
  width = 27,
  height = 16.9,
  units = "cm",
  dpi = 600)

```

```{r rep_S2_stim_bayes_fullmodel_plotting_new, echo=FALSE, eval=F, warning = F, message=F}

# load images ###################################

# plotexample Representation.png
image_1 <- image_read(paste0("../illustrations/plotexample ", levels(d2$condition)[1], ".png"))
image_2 <- image_read(paste0("../illustrations/plotexample ", levels(d2$condition)[2], ".png"))
image_3 <- image_read(paste0("../illustrations/plotexample ", levels(d2$condition)[3], ".png"))
image_4 <- image_read(paste0("../illustrations/plotexample ", levels(d2$condition)[4], ".png"))
# stimuli Representation.png
image_1_2 <- image_read(paste0("../illustrations/stimuli ", levels(d2$condition)[1], ".png"))
image_2_2 <- image_read(paste0("../illustrations/stimuli ", levels(d2$condition)[2], ".png"))
image_3_3 <- image_read(paste0("../illustrations/stimuli ", levels(d2$condition)[3], ".png"))
image_4_4 <- image_read(paste0("../illustrations/stimuli ", levels(d2$condition)[4], ".png"))
# create grobs
image_1_grob <- rasterGrob(image_1, interpolate = TRUE)
image_2_grob <- rasterGrob(image_2, interpolate = TRUE)
image_3_grob <- rasterGrob(image_3, interpolate = TRUE)
image_4_grob <- rasterGrob(image_4, interpolate = TRUE)
image_1_2_grob <- rasterGrob(image_1_2, interpolate = TRUE)
image_2_2_grob <- rasterGrob(image_2_2, interpolate = TRUE)
image_3_2_grob <- rasterGrob(image_3_3, interpolate = TRUE)
image_4_2_grob <- rasterGrob(image_4_4, interpolate = TRUE)

# plot 1 ##################
plot1 <- ggplot() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey70", alpha = 0.75) +
  
  geom_point(
    data = d2 %>% filter(condition == levels(condition)[1]),
    aes(x = ageinyears, y = mean, colour = colour),
    alpha = 0.5, shape = 1, size = 2
  ) +
  
  geom_smooth(
    data = f2 %>% filter(condition == levels(condition)[1]),
    aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill = colour, colour = colour),
    stat = "identity", alpha = 0.2, linewidth = 0.8
  ) +
  
  # shape 21 uses both fill (inside) and colour (stroke)
  geom_point(
    data = p2 %>% filter(condition == levels(condition)[1]),
    aes(x = days/365.25, y = 0.5, fill = colour, colour = colour),
    size = 4, shape = 21, stroke = 1
  ) +
  
  # constant black overlay: set outside aes()
  geom_point(
    data = p2 %>% filter(condition == levels(condition)[1]),
    aes(x = days/365.25, y = 0.5),
    fill = "black", colour = "black", size = 0.5, shape = 21, stroke = 1
  ) +
  
  # text: move color/fontface outside aes()
  geom_text(
    data = p2 %>% filter(condition == levels(condition)[1]),
    aes(label = months, x = days/365.25, y = 0.13),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  geom_text(
    data = p2 %>% filter(condition == levels(condition)[1]),
    aes(label = "months", x = days/365.25, y = .31),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  scale_colour_identity() +
  scale_fill_identity() +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  labs(x = "Age", y = "Proportion Correct") +
  coord_cartesian(ylim = c(0, 1), xlim = c(2.7, 7.3)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.border = element_rect(colour = "grey30", fill = NA, size = 1),
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title = element_text(face = "bold", size = rel(0.8)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )


# plot 2  ##################
plot2 <- ggplot() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey70", alpha = 0.75) +
  
  geom_point(
    data = d2 %>% filter(condition == levels(condition)[2]),
    aes(x = ageinyears, y = mean, colour = colour),
    alpha = 0.5, shape = 1, size = 2
  ) +
  
  geom_smooth(
    data = f2 %>% filter(condition == levels(condition)[2]),
    aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill = colour, colour = colour),
    stat = "identity", alpha = 0.2, linewidth = 0.8
  ) +
  
  # shape 21 uses both fill (inside) and colour (stroke)
  geom_point(
    data = p2 %>% filter(condition == levels(condition)[2]),
    aes(x = days/365.25, y = 0.5, fill = colour, colour = colour),
    size = 4, shape = 21, stroke = 1
  ) +
  
  # constant black overlay: set outside aes()
  geom_point(
    data = p2 %>% filter(condition == levels(condition)[2]),
    aes(x = days/365.25, y = 0.5),
    fill = "black", colour = "black", size = 0.5, shape = 21, stroke = 1
  ) +
  
  # text: move color/fontface outside aes()
  geom_text(
    data = p2 %>% filter(condition == levels(condition)[2]),
    aes(label = months, x = days/365.25, y = 0.13),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  geom_text(
    data = p2 %>% filter(condition == levels(condition)[2]),
    aes(label = "months", x = days/365.25, y = .31),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  scale_colour_identity() +
  scale_fill_identity() +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  labs(x = "Age", y = "Proportion Correct") +
  coord_cartesian(ylim = c(0, 1), xlim = c(2.7, 7.3)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.border = element_rect(colour = "grey30", fill = NA, size = 1),
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title = element_text(face = "bold", size = rel(0.8)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )

# plot 3  ##################
plot3 <- ggplot() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey70", alpha = 0.75) +
  
  geom_point(
    data = d2 %>% filter(condition == levels(condition)[3]),
    aes(x = ageinyears, y = mean, colour = colour),
    alpha = 0.5, shape = 1, size = 2
  ) +
  
  geom_smooth(
    data = f2 %>% filter(condition == levels(condition)[3]),
    aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill = colour, colour = colour),
    stat = "identity", alpha = 0.2, linewidth = 0.8
  ) +
  
  # shape 21 uses both fill (inside) and colour (stroke)
  geom_point(
    data = p2 %>% filter(condition == levels(condition)[3]),
    aes(x = days/365.25, y = 0.5, fill = colour, colour = colour),
    size = 4, shape = 21, stroke = 1
  ) +
  
  # constant black overlay: set outside aes()
  geom_point(
    data = p2 %>% filter(condition == levels(condition)[3]),
    aes(x = days/365.25, y = 0.5),
    fill = "black", colour = "black", size = 0.5, shape = 21, stroke = 1
  ) +
  
  # text: move color/fontface outside aes()
  geom_text(
    data = p2 %>% filter(condition == levels(condition)[3]),
    aes(label = months, x = days/365.25, y = 0.13),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  geom_text(
    data = p2 %>% filter(condition == levels(condition)[3]),
    aes(label = "months", x = days/365.25, y = .31),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  scale_colour_identity() +
  scale_fill_identity() +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  labs(x = "Age", y = "Proportion Correct") +
  coord_cartesian(ylim = c(0, 1), xlim = c(2.7, 7.3)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.border = element_rect(colour = "grey30", fill = NA, size = 1),
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title = element_text(face = "bold", size = rel(0.8)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )

# plot 4  ##################
plot4 <- ggplot() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey70", alpha = 0.75) +
  
  geom_point(
    data = d2 %>% filter(condition == levels(condition)[4]),
    aes(x = ageinyears, y = mean, colour = colour),
    alpha = 0.5, shape = 1, size = 2
  ) +
  
  geom_smooth(
    data = f2 %>% filter(condition == levels(condition)[4]),
    aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill = colour, colour = colour),
    stat = "identity", alpha = 0.2, linewidth = 0.8
  ) +
  
  # shape 21 uses both fill (inside) and colour (stroke)
  geom_point(
    data = p2 %>% filter(condition == levels(condition)[4]),
    aes(x = days/365.25, y = 0.5, fill = colour, colour = colour),
    size = 4, shape = 21, stroke = 1
  ) +
  
  # constant black overlay: set outside aes()
  geom_point(
    data = p2 %>% filter(condition == levels(condition)[4]),
    aes(x = days/365.25, y = 0.5),
    fill = "black", colour = "black", size = 0.5, shape = 21, stroke = 1
  ) +
  
  # text: move color/fontface outside aes()
  geom_text(
    data = p2 %>% filter(condition == levels(condition)[4]),
    aes(label = months, x = days/365.25, y = 0.13),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  geom_text(
    data = p2 %>% filter(condition == levels(condition)[4]),
    aes(label = "months", x = days/365.25, y = .31),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  scale_colour_identity() +
  scale_fill_identity() +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  labs(x = "Age", y = "Proportion Correct") +
  coord_cartesian(ylim = c(0, 1), xlim = c(2.7, 7.3)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.border = element_rect(colour = "grey30", fill = NA, size = 1),
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title = element_text(face = "bold", size = rel(0.8)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )

# Combine plots #######################


S2_complete <- ggdraw() +
  draw_plot_label(label = paste(levels(d2$condition)[1]), size = 14, x = 0, y = 0.98) +
  draw_plot_label(label = paste(levels(d2$condition)[2]), size = 14, x = 0.25, y = 0.98) +
  draw_plot_label(label = paste(levels(d2$condition)[3]), size = 14, x = 0.46, y = 0.98) +
  draw_plot_label(label = paste(levels(d2$condition)[4]), size = 14, x = 0.7, y = 0.98) +
  draw_plot(image_1_grob, y = 0.77, x = 0.05, width = .2, height = .2) +
  draw_plot(image_2_grob, y = 0.77, x = 0.292, width = .2, height = .2) +
  draw_plot(image_3_grob, y = 0.77, x = 0.541, width = .2, height = .2) +
  draw_plot(image_4_grob, y = 0.77, x = 0.79, width = .2, height = .2) +
  draw_plot(image_1_2_grob, y = 0.47, x = -0.01, width = .32, height = .32) +
  draw_plot(image_2_2_grob, y = 0.47, x =  0.23, width = .32, height = .32) +
  draw_plot(image_3_2_grob, y = 0.47, x =  0.48, width = .32, height = .32) +
  draw_plot(image_4_2_grob, y = 0.47, x =  0.728, width = .32, height = .32) +
  draw_plot(plot1, y = 0, x =  0.01, width = .25, height = .44) +
  draw_plot(plot2, y = 0, x =  0.25, width = .25, height = .44) +
  draw_plot(plot3, y = 0, x =  0.5, width = .25, height = .44) +
  draw_plot(plot4, y = 0, x =  0.75, width = .25, height = .44) +
  draw_plot_label(label = "A", size = 14, x = 0, y = 0.89) +
  draw_plot_label(label = "B", size = 14, x = 0, y = 0.65) +
  draw_plot_label(label = "C", size = 14, x = 0, y = 0.26)


# Saving plots ##################

ggsave(
  filename = "../illustrations/S2_complete.pdf",
  plot = S2_complete,
  width = 27,
  height = 16.9,
  units = "cm",
  dpi = 600   # or 600 for very high resolution
)

# shell.exec("../illustrations/S2_complete.pdf")

ggsave(
  filename = "../illustrations/S2_complete.jpg",
  plot = S2_complete,
  width = 27,
  height = 16.9,
  units = "cm",
  dpi = 600   # or 600 for very high resolution
)
              

ggsave(
  filename = "../illustrations/S2_complete.png",
  plot = S2_complete,
  width = 27,
  height = 16.9,
  units = "cm",
  dpi = 600   # or 600 for very high resolution
)




```

```{r rep_S3_stim_bayes_fullmodel_plotting_new, echo=FALSE, eval=F, warning = F, message=F}

# load images ###################################

# plotexample Representation.png
image_1 <- image_read(paste0("../illustrations/plotexample ", levels(d3$condition)[1], ".png"))
image_2 <- image_read(paste0("../illustrations/plotexample ", levels(d3$condition)[2], ".png"))
image_3 <- image_read(paste0("../illustrations/plotexample ", levels(d3$condition)[3], ".png"))
image_4 <- image_read(paste0("../illustrations/plotexample ", levels(d3$condition)[4], ".png"))
# stimuli Representation.png
image_1_2 <- image_read(paste0("../illustrations/stimuli ", levels(d3$condition)[1], ".png"))
image_2_2 <- image_read(paste0("../illustrations/stimuli ", levels(d3$condition)[2], ".png"))
image_3_3 <- image_read(paste0("../illustrations/stimuli ", levels(d3$condition)[3], ".png"))
image_4_4 <- image_read(paste0("../illustrations/stimuli ", levels(d3$condition)[4], ".png"))
# create grobs
image_1_grob <- rasterGrob(image_1, interpolate = TRUE)
image_2_grob <- rasterGrob(image_2, interpolate = TRUE)
image_3_grob <- rasterGrob(image_3, interpolate = TRUE)
image_4_grob <- rasterGrob(image_4, interpolate = TRUE)
image_1_2_grob <- rasterGrob(image_1_2, interpolate = TRUE)
image_2_2_grob <- rasterGrob(image_2_2, interpolate = TRUE)
image_3_2_grob <- rasterGrob(image_3_3, interpolate = TRUE)
image_4_2_grob <- rasterGrob(image_4_4, interpolate = TRUE)

# plot 1 ###########################
plot1 <- ggplot() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey70", alpha = 0.75) +
  
  geom_point(
    data = d3 %>% filter(condition == levels(condition)[1]),
    aes(x = ageinyears, y = mean, colour = colour),
    alpha = 0.5, shape = 1, size = 2
  ) +
  
  geom_smooth(
    data = f3 %>% filter(condition == levels(condition)[1]),
    aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill = colour, colour = colour),
    stat = "identity", alpha = 0.2, linewidth = 0.8
  ) +
  
  # shape 21 uses both fill (inside) and colour (stroke)
  geom_point(
    data = p3 %>% filter(condition == levels(condition)[1]),
    aes(x = days/365.25, y = 0.5, fill = colour, colour = colour),
    size = 4, shape = 21, stroke = 1
  ) +
  
  # constant black overlay: set outside aes()
  geom_point(
    data = p3 %>% filter(condition == levels(condition)[1]),
    aes(x = days/365.25, y = 0.5),
    fill = "black", colour = "black", size = 0.5, shape = 21, stroke = 1
  ) +
  
  # text: move color/fontface outside aes()
  geom_text(
    data = p3 %>% filter(condition == levels(condition)[1]),
    aes(label = months, x = days/365.25, y = 0.13),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  geom_text(
    data = p3 %>% filter(condition == levels(condition)[1]),
    aes(label = "months", x = days/365.25, y = .31),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  scale_colour_identity() +
  scale_fill_identity() +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  labs(x = "Age", y = "Proportion Correct") +
  coord_cartesian(ylim = c(0, 1), xlim = c(2.7, 7.3)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.border = element_rect(colour = "grey30", fill = NA, size = 1),
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title = element_text(face = "bold", size = rel(0.8)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )


# plot 2 ###########################
plot2 <- ggplot() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey70", alpha = 0.75) +
  
  geom_point(
    data = d3 %>% filter(condition == levels(condition)[2]),
    aes(x = ageinyears, y = mean, colour = colour),
    alpha = 0.5, shape = 1, size = 2
  ) +
  
  geom_smooth(
    data = f3 %>% filter(condition == levels(condition)[2]),
    aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill = colour, colour = colour),
    stat = "identity", alpha = 0.2, linewidth = 0.8
  ) +
  
  # shape 21 uses both fill (inside) and colour (stroke)
  geom_point(
    data = p3 %>% filter(condition == levels(condition)[2]),
    aes(x = days/365.25, y = 0.5, fill = colour, colour = colour),
    size = 4, shape = 21, stroke = 1
  ) +
  
  # constant black overlay: set outside aes()
  geom_point(
    data = p3 %>% filter(condition == levels(condition)[2]),
    aes(x = days/365.25, y = 0.5),
    fill = "black", colour = "black", size = 0.5, shape = 21, stroke = 1
  ) +
  
  # text: move color/fontface outside aes()
  geom_text(
    data = p3 %>% filter(condition == levels(condition)[2]),
    aes(label = months, x = days/365.25, y = 0.13),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  geom_text(
    data = p3 %>% filter(condition == levels(condition)[2]),
    aes(label = "months", x = days/365.25, y = .31),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  scale_colour_identity() +
  scale_fill_identity() +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  labs(x = "Age", y = "Proportion Correct") +
  coord_cartesian(ylim = c(0, 1), xlim = c(2.7, 7.3)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.border = element_rect(colour = "grey30", fill = NA, size = 1),
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title = element_text(face = "bold", size = rel(0.8)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )

# plot 3 ###########################
plot3 <- ggplot() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey70", alpha = 0.75) +
  
  geom_point(
    data = d3 %>% filter(condition == levels(condition)[3]),
    aes(x = ageinyears, y = mean, colour = colour),
    alpha = 0.5, shape = 1, size = 2
  ) +
  
  geom_smooth(
    data = f3 %>% filter(condition == levels(condition)[3]),
    aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill = colour, colour = colour),
    stat = "identity", alpha = 0.2, linewidth = 0.8
  ) +
  
  # shape 21 uses both fill (inside) and colour (stroke)
  geom_point(
    data = p3 %>% filter(condition == levels(condition)[3]),
    aes(x = days/365.25, y = 0.5, fill = colour, colour = colour),
    size = 4, shape = 21, stroke = 1
  ) +
  
  # constant black overlay: set outside aes()
  geom_point(
    data = p3 %>% filter(condition == levels(condition)[3]),
    aes(x = days/365.25, y = 0.5),
    fill = "black", colour = "black", size = 0.5, shape = 21, stroke = 1
  ) +
  
  # text: move color/fontface outside aes()
  geom_text(
    data = p3 %>% filter(condition == levels(condition)[3]),
    aes(label = months, x = days/365.25, y = 0.13),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  geom_text(
    data = p3 %>% filter(condition == levels(condition)[3]),
    aes(label = "months", x = days/365.25, y = .31),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  scale_colour_identity() +
  scale_fill_identity() +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  labs(x = "Age", y = "Proportion Correct") +
  coord_cartesian(ylim = c(0, 1), xlim = c(2.7, 7.3)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.border = element_rect(colour = "grey30", fill = NA, size = 1),
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title = element_text(face = "bold", size = rel(0.8)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )

# plot 4 ###########################
plot4 <- ggplot() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey70", alpha = 0.75) +
  
  geom_point(
    data = d3 %>% filter(condition == levels(condition)[4]),
    aes(x = ageinyears, y = mean, colour = colour),
    alpha = 0.5, shape = 1, size = 2
  ) +
  
  geom_smooth(
    data = f3 %>% filter(condition == levels(condition)[4]),
    aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill = colour, colour = colour),
    stat = "identity", alpha = 0.2, linewidth = 0.8
  ) +
  
  # shape 21 uses both fill (inside) and colour (stroke)
  geom_point(
    data = p3 %>% filter(condition == levels(condition)[4]),
    aes(x = days/365.25, y = 0.5, fill = colour, colour = colour),
    size = 4, shape = 21, stroke = 1
  ) +
  
  # constant black overlay: set outside aes()
  geom_point(
    data = p3 %>% filter(condition == levels(condition)[4]),
    aes(x = days/365.25, y = 0.5),
    fill = "black", colour = "black", size = 0.5, shape = 21, stroke = 1
  ) +
  
  # text: move color/fontface outside aes()
  geom_text(
    data = p3 %>% filter(condition == levels(condition)[4]),
    aes(label = months, x = days/365.25, y = 0.13),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  geom_text(
    data = p3 %>% filter(condition == levels(condition)[4]),
    aes(label = "months", x = days/365.25, y = .31),
    color = "black", fontface = "bold",
    angle = 90, size = 3, vjust = 0.5
  ) +
  
  scale_colour_identity() +
  scale_fill_identity() +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  labs(x = "Age", y = "Proportion Correct") +
  coord_cartesian(ylim = c(0, 1), xlim = c(2.7, 7.3)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.border = element_rect(colour = "grey30", fill = NA, size = 1),
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title = element_text(face = "bold", size = rel(0.8)),
    axis.text = element_text(size = rel(0.8)),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )

# Combine plots #######################

S3_complete <- ggdraw() +
  draw_plot_label(label = paste(levels(d3$condition)[1]), size = 14, x = 0.028, y = 0.98) +
  draw_plot_label(label = paste(levels(d3$condition)[2]), size = 14, x = 0.265, y = 0.98) +
  draw_plot_label(label = paste(levels(d3$condition)[3]), size = 14, x = 0.487, y = 0.98) +
  draw_plot_label(label = paste(levels(d3$condition)[4]), size = 14, x = 0.73, y = 0.98) +
  draw_plot(image_1_grob, y = 0.77, x = 0.05, width = .2, height = .2) +
  draw_plot(image_2_grob, y = 0.77, x = 0.292, width = .2, height = .2) +
  draw_plot(image_3_grob, y = 0.77, x = 0.541, width = .2, height = .2) +
  draw_plot(image_4_grob, y = 0.77, x = 0.79, width = .2, height = .2) +
  draw_plot(image_1_2_grob, y = 0.47, x = -0.01, width = .32, height = .32) +
  draw_plot(image_2_2_grob, y = 0.47, x =  0.23, width = .32, height = .32) +
  draw_plot(image_3_2_grob, y = 0.47, x =  0.48, width = .32, height = .32) +
  draw_plot(image_4_2_grob, y = 0.47, x =  0.728, width = .32, height = .32) +
  draw_plot(plot1, y = 0, x =  0.01, width = .25, height = .44) +
  draw_plot(plot2, y = 0, x =  0.25, width = .25, height = .44) +
  draw_plot(plot3, y = 0, x =  0.5, width = .25, height = .44) +
  draw_plot(plot4, y = 0, x =  0.75, width = .25, height = .44) +
  draw_plot_label(label = "A", size = 14, x = 0, y = 0.89) +
  draw_plot_label(label = "B", size = 14, x = 0, y = 0.65) +
  draw_plot_label(label = "C", size = 14, x = 0, y = 0.26)


# saving plots ###########################

ggsave(
  filename = "../illustrations/S3_complete.pdf",
  plot = S3_complete,
  width = 27,
  height = 16.9,
  units = "cm",
  dpi = 600   
)

# shell.exec("../illustrations/S3_complete.pdf")

ggsave(
  filename = "../illustrations/S3_complete.jpg",
  plot = S3_complete,
  width = 27,
  height = 16.9,
  units = "cm",
  dpi = 600  
)
   
ggsave(
  filename = "../illustrations/S3_complete.png",
  plot = S3_complete,
  width = 27,
  height = 16.9,
  units = "cm",
  dpi = 600  
)           

```

<!-- Run additional item models for all three studies (not evaluated to save time) -->

```{r S1S2S3_item_model,echo=FALSE, eval=F, warning = F, message=F}

# Main analysis:
# S1.full.bm<-brm(correct~condition*z.age+z.trial+sex+(z.trial|subid) 

### STUDY 1 ###
# table(rep.S1.bayes.data$condition, rep.S1.bayes.data$item)
# table(rep.S1.bayes.data$item)
# table(rep.S1.bayes.data$condition)

S1.item.model<-brm(correct ~ condition*z.age +z.trial +sex +(z.trial|subid) +(z.age|item), 
               data= rep.S1.bayes.data, 
               family=bernoulli(),
               chains = 4,
               iter= 5000,
               cores= 4)

S1.item.model <- add_criterion(S1.item.model, c("loo", "waic"))

saveRDS(S1.item.model, "../models/S1.item.model.rds")


### STUDY 2 ###
# table(rep.S2.bayes.data$condition, rep.S2.bayes.data$item)
# table(rep.S2.bayes.data$item)
# table(rep.S2.bayes.data$condition)

S2.item.model<-brm(correct ~ condition*z.age +z.trial +sex +(z.trial|subid) +(z.age|item), 
               data= rep.S2.bayes.data, 
               family=bernoulli(),
               chains = 4,
               iter= 5000,
               cores= 4)

S2.item.model <- add_criterion(S2.item.model, c("loo", "waic"))

saveRDS(S2.item.model, "../models/S2.item.model.rds")

### STUDY 3 ###
# table(rep.S2.bayes.data$condition, rep.S2.bayes.data$item)
# table(rep.S2.bayes.data$item)
# table(rep.S2.bayes.data$condition)

S3.item.model<-brm(correct ~ condition*z.age +z.trial +sex +(z.trial|subid) +(z.age|item), 
               data= rep.S3.bayes.data, 
               family=bernoulli(),
               chains = 4,
               iter= 5000,
               cores= 4)

S3.item.model <- add_criterion(S3.item.model, c("loo", "waic"))

saveRDS(S3.item.model, "../models/S3.item.model.rds")

```

```{r S1S2S3_itemvsfull_comp, echo=FALSE, eval=F, warning = F, message=F}

### MODEL COMPARISON

# STUDY 1 - item vs full #######################################
S1.itemvsfull.comp <- loo_compare(S1.item.model, S1.full.bm, 
                                  criterion = "waic")%>%as_tibble(rownames = "index")

S1.itemvsfull.comp  <- data.frame(S1.itemvsfull.comp , row.names = "index")

S1.itemvsfull.weights <- model_weights(S1.item.model, S1.full.bm, criterion = "waic") 
S1.itemvsfull.weights <- S1.itemvsfull.weights %>% as_tibble(rownames = "index")
S1.itemvsfull.weights <- data.frame(S1.itemvsfull.weights, row.names = "index")

saveRDS(S1.itemvsfull.comp, "../models/S1.itemvsfull.comp.rds")
saveRDS(S1.itemvsfull.weights, "../models/S1.itemvsfull.weights.rds")


# STUDY 2 - item vs full #######################################
S2.itemvsfull.comp <- loo_compare(S2.item.model, S2.full.bm, 
                                  criterion = "waic")%>%as_tibble(rownames = "index")

S2.itemvsfull.comp  <- data.frame(S2.itemvsfull.comp , row.names = "index")

S2.itemvsfull.weights <- model_weights(S2.item.model, S2.full.bm, criterion = "waic") 
S2.itemvsfull.weights <- S2.itemvsfull.weights %>% as_tibble(rownames = "index")
S2.itemvsfull.weights <- data.frame(S2.itemvsfull.weights, row.names = "index")

saveRDS(S2.itemvsfull.comp, "../models/S2.itemvsfull.comp.rds")
saveRDS(S2.itemvsfull.weights, "../models/S2.itemvsfull.weights.rds")


# STUDY 3 - item vs full #######################################
S3.itemvsfull.comp <- loo_compare(S3.item.model, S3.full.bm, 
                                  criterion = "waic")%>%as_tibble(rownames = "index")

S3.itemvsfull.comp  <- data.frame(S3.itemvsfull.comp , row.names = "index")

S3.itemvsfull.weights <- model_weights(S3.item.model, S3.full.bm, criterion = "waic") 
S3.itemvsfull.weights <- S3.itemvsfull.weights %>% as_tibble(rownames = "index")
S3.itemvsfull.weights <- data.frame(S3.itemvsfull.weights, row.names = "index")

saveRDS(S3.itemvsfull.comp, "../models/S3.itemvsfull.comp.rds")
saveRDS(S3.itemvsfull.weights, "../models/S3.itemvsfull.weights.rds")


```

```{r S1_item_ppcheck_rhat_bulkESS_coefftables, echo=FALSE, eval=T, warning = F, message=F}

S1.item.model <- readRDS("../models/S1.item.model.rds")
S1.itemvsfull.comp <- readRDS("../models/S1.itemvsfull.comp.rds")
S1.itemvsfull.weights <- readRDS("../models/S1.itemvsfull.weights.rds")

S2.item.model <- readRDS("../models/S2.item.model.rds")
S2.itemvsfull.comp <- readRDS("../models/S2.itemvsfull.comp.rds")
S2.itemvsfull.weights <- readRDS("../models/S2.itemvsfull.weights.rds")


S3.item.model <- readRDS("../models/S3.item.model.rds")
S3.itemvsfull.comp <- readRDS("../models/S3.itemvsfull.comp.rds")
S3.itemvsfull.weights <- readRDS("../models/S3.itemvsfull.weights.rds")



# POSTERIOR PREDICTICE CHECKS ###################
# pp_check(S1.item.model)
# pp_check(S1.item.model, type = "bars")
# 
# pp_check(S2.item.model)
# pp_check(S2.item.model, type = "bars")
# 
# pp_check(S3.item.model)
# pp_check(S3.item.model, type = "bars")

### inspect rhat --> always 1 --> good
### inspect Bulk_ESS --> always > 1000 --> good

#################       Estimate Est.Error l-95% CI 
# summary(S1.item.model) # Intercept 2.04      0.23     1.61
# summary(S2.item.model) # Intercept 1.09      0.25     0.60
# summary(S3.item.model) # Intercept 1.06      0.21     0.64





# S1 item model prepping for text and table ####################

# for reporting BULK_ESS and Coefficients
S1.item.coef <- summarise_draws(as_draws_df(S1.item.model)) # ! standard is just 90% CrI

# NOTE: # as_draws_df() from posterior uses 90% CrIs
# we preregistered using 2.5% and 97.5% quantiles
draws_df <- as_draws_df(S1.item.model)
quantiles_df <- as.data.frame(t(apply(draws_df, 2, quantile, probs = c(0.025, 0.975))))
quantiles_df <- tibble::rownames_to_column(quantiles_df, var = "variable")
names(quantiles_df)[2:3] <- c("q2.5", "q97.5")

S1.item.coef <- left_join(S1.item.coef, quantiles_df, by = "variable") 

# for table in appendix:
S1.item.coef.table <- S1.item.coef

# for reporting in text:
S1.item.coef <- S1.item.coef %>% 
  slice(1:16) %>%
  mutate(variable = gsub("b_", "", variable)) %>% 
  mutate(variable = gsub("condition", "", variable)) %>% 
  data.frame(row.names = "variable")



# S2 item model prepping for text and table ####################

# for reporting BULK_ESS and Coefficients
S2.item.coef <- summarise_draws(as_draws_df(S2.item.model)) # ! standard is just 90% CrI

# NOTE: # as_draws_df() from posterior uses 90% CrIs
# we preregistered using 2.5% and 97.5% quantiles
draws_df <- as_draws_df(S2.item.model)
quantiles_df <- as.data.frame(t(apply(draws_df, 2, quantile, probs = c(0.025, 0.975))))
quantiles_df <- tibble::rownames_to_column(quantiles_df, var = "variable")
names(quantiles_df)[2:3] <- c("q2.5", "q97.5")

S2.item.coef <- left_join(S2.item.coef, quantiles_df, by = "variable") 

# for table in appendix:
S2.item.coef.table <- S2.item.coef

# for reporting in text:
S2.item.coef <- S2.item.coef %>% 
  slice(1:16) %>%
  mutate(variable = gsub("b_", "", variable)) %>% 
  mutate(variable = gsub("condition", "", variable)) %>% 
  data.frame(row.names = "variable")



# S3 item model prepping for text and table ####################

# for reporting BULK_ESS and Coefficients
S3.item.coef <- summarise_draws(as_draws_df(S3.item.model)) # ! standard is just 90% CrI

# NOTE: # as_draws_df() from posterior uses 90% CrIs
# we preregistered using 2.5% and 97.5% quantiles
draws_df <- as_draws_df(S3.item.model)
quantiles_df <- as.data.frame(t(apply(draws_df, 2, quantile, probs = c(0.025, 0.975))))
quantiles_df <- tibble::rownames_to_column(quantiles_df, var = "variable")
names(quantiles_df)[2:3] <- c("q2.5", "q97.5")

S3.item.coef <- left_join(S3.item.coef, quantiles_df, by = "variable") 



# for table in appendix:
S3.item.coef.table <- S3.item.coef


# for reporting in text:
S3.item.coef <- S3.item.coef %>% 
  slice(1:16) %>%
  mutate(variable = gsub("b_", "", variable)) %>% 
  mutate(variable = gsub("condition", "", variable)) %>% 
  data.frame(row.names = "variable")

```

```{r S1S2S3_item_plotting, echo=FALSE, eval=T, warning = F, message=F}

# prep data 1 #######

S1.item_effects <- ranef(S1.item.model)$item

# Extract random intercepts
S1.item_intercepts <- as_tibble(S1.item_effects[, , "Intercept"], rownames = "item") %>%
  rename(
    estimate = Estimate,
    lower = Q2.5,
    upper = Q97.5) %>% 
  mutate(condition = substr(item,1,4)) %>% 
  mutate(item = substr(item, 10,10)) %>% 
  mutate(condition = case_when(
    condition == "repr" ~ "Representation", 
    condition == "pars" ~ "Pars Pro Toto",
    condition == "fsim" ~"Simple Form Analogy",
    condition == "fcom" ~ "Complex Form Analogy",
    condition == "abpo" ~ "Absolute Position",
    condition == "repo" ~ "Relative Position",
    condition == "orob" ~ "Orientation of Object",
    condition == "orfe" ~ "Orientation of Feature",
    condition == "siob" ~ "Size of Object", 
    condition == "sife" ~ "Size of Feature", 
    condition == "nuob" ~ "Number of Object", 
    condition == "nufe" ~ "Number of Feature",
    TRUE ~ as.character(condition))) %>% 
  mutate(condition = factor(condition, levels = c(
    "Representation", # first level becomes reference
    "Pars Pro Toto", 
    "Simple Form Analogy", 
    "Complex Form Analogy"))) %>% 
  mutate(item = factor(item, levels = c("4", "3", "2", "1")))

S1.item_intercepts <- add_colour(S1.item_intercepts)

# prep data 2 ######################

S2.item_effects <- ranef(S2.item.model)$item

# Extract random intercepts
S2.item_intercepts <- as_tibble(S2.item_effects[, , "Intercept"], rownames = "item") %>%
  rename(
    estimate = Estimate,
    lower = Q2.5,
    upper = Q97.5) %>% 
  mutate(condition = substr(item,1,4)) %>% 
  mutate(item = substr(item, 10,10)) %>% 
  mutate(condition = case_when(
    condition == "repr" ~ "Representation", 
    condition == "pars" ~ "Pars Pro Toto",
    condition == "fsim" ~"Simple Form Analogy",
    condition == "fcom" ~ "Complex Form Analogy",
    condition == "abpo" ~ "Absolute Position",
    condition == "repo" ~ "Relative Position",
    condition == "orob" ~ "Orientation of Object",
    condition == "orfe" ~ "Orientation of Feature",
    condition == "siob" ~ "Size of Object", 
    condition == "sife" ~ "Size of Feature", 
    condition == "nuob" ~ "Number of Object", 
    condition == "nufe" ~ "Number of Feature",
    TRUE ~ as.character(condition))) %>% 
  mutate(condition = factor(condition, levels = c(
    "Absolute Position",
    "Relative Position",
    "Orientation of Object",
    "Orientation of Feature"))) %>%
  mutate(item = factor(item, levels = c("4", "3", "2", "1")))

S2.item_intercepts <- add_colour(S2.item_intercepts)



# prep data 3 #####################

S3.item_effects <- ranef(S3.item.model)$item

# Extract random intercepts
S3.item_intercepts <- as_tibble(S3.item_effects[, , "Intercept"], rownames = "item") %>%
  rename(
    estimate = Estimate,
    lower = Q2.5,
    upper = Q97.5) %>% 
  mutate(condition = substr(item,1,4)) %>% 
  mutate(item = substr(item, 10,10)) %>% 
  mutate(condition = case_when(
    condition == "repr" ~ "Representation", 
    condition == "pars" ~ "Pars Pro Toto",
    condition == "fsim" ~"Simple Form Analogy",
    condition == "fcom" ~ "Complex Form Analogy",
    condition == "abpo" ~ "Absolute Position",
    condition == "repo" ~ "Relative Position",
    condition == "orob" ~ "Orientation of Object",
    condition == "orfe" ~ "Orientation of Feature",
    condition == "siob" ~ "Size of Object", 
    condition == "sife" ~ "Size of Feature", 
    condition == "nuob" ~ "Number of Object", 
    condition == "nufe" ~ "Number of Feature",
    TRUE ~ as.character(condition))) %>% 
  mutate(condition = factor(condition, levels = c(
    "Size of Object", # first level becomes reference
    "Size of Feature",
    "Number of Object",
    "Number of Feature"))) %>%
  mutate(item = factor(item, levels = c("4", "3", "2", "1")))

S3.item_intercepts <- add_colour(S3.item_intercepts)



# plot 1 ##################
S1.item.plot <- ggplot(S1.item_intercepts, aes(x = item, y = estimate)) +
  geom_point(aes(color = I(colour))) +
  geom_errorbar(aes(ymin = lower, ymax = upper, color = I(colour)), width = 0.6, size = .5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  coord_flip() +
  facet_wrap(~ condition, scales = "free_y", ncol = 1) +
  scale_y_continuous(limits = c(-1, 1)) +
  labs(
    x = "Item",
    y = "Estimated Deviation from Overall Intercept (log-odds)"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 6),
    axis.title.x  = element_text(size = 8),     
    axis.title.y  = element_text(size = 8),
    legend.position = "none",  
    strip.text = element_text(size = 8, face = "bold"))

# plot 2 ############

S2.item.plot <- ggplot(S2.item_intercepts, aes(x = item, y = estimate)) +
  geom_point(aes(color = I(colour))) +
  geom_errorbar(aes(ymin = lower, ymax = upper, color = I(colour)), width = 0.6, size = .5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  coord_flip() +
  facet_wrap(~ condition, scales = "free_y", ncol = 1) +
  labs(
    x = "Item",
    y = "Estimated Deviation from Overall Intercept (log-odds)"
  ) +
  scale_y_continuous(limits = c(-1, 1)) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 6),
    axis.title.x  = element_text(size = 8),     
    axis.title.y  = element_text(size = 8),     
    legend.position = "none",  
    strip.text = element_text(size = 8, face = "bold"))

# plot 3 ################################

S3.item.plot <- ggplot(S3.item_intercepts, aes(x = item, y = estimate)) +
  geom_point(aes(color = I(colour))) +
  geom_errorbar(aes(ymin = lower, ymax = upper, color = I(colour)), width = 0.6, size = .5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  coord_flip() +
  facet_wrap(~ condition, scales = "free_y", ncol = 1) +
  labs(
    x = "Item",
    y = "Estimated Deviation from Overall Intercept (log-odds)"
  ) +
  scale_y_continuous(limits = c(-1, 1)) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 6),
    axis.title.x  = element_text(size = 8),     
    axis.title.y  = element_text(size = 8),
    legend.position = "none",  
    strip.text = element_text(size = 8, face = "bold"))

# combine plots  ##################

# hide x axis
S1.item.plot <- S1.item.plot + theme(axis.title.x = element_blank(),
                                       axis.text.x  = element_blank(),
                                       axis.ticks.x = element_blank())
S2.item.plot <- S2.item.plot + theme(axis.title.x = element_blank(),
                                       axis.text.x  = element_blank(),
                                       axis.ticks.x = element_blank())


S1S2S3_item_plot <- plot_grid(
  S1.item.plot, 
  S2.item.plot, 
  S3.item.plot,
  ncol = 1,
  labels = c("A", "B", "C"),
  label_size = 10,
  label_y = .95,   # vertical center
  hjust = -4,    # shift labels left
  align = "v", axis = "tb"
)


ggsave(
  filename = "../illustrations/S1S2S3_item_plot.pdf",
  plot = S1S2S3_item_plot,
  width = 17,
  height = 21,
  units = "cm",
  dpi = 600   
)

ggsave(
  filename = "../illustrations/S1S2S3_item_plot.png",
  plot = S1S2S3_item_plot,
  width = 17,
  height = 21,
  units = "cm",
  dpi = 600   
)

ggsave(
  filename = "../illustrations/S1S2S3_item_plot.jpg",
  plot = S1S2S3_item_plot,
  width = 17,
  height = 21,
  units = "cm",
  dpi = 600   
)


```

```{r rep_s1_item_unclear, echo = FALSE, include=F, eval=F, results='asis'}

S1.item.model


S1.full.bm <- readRDS("../models/S1.full.bm.rds")
S1.null.bm <- readRDS("../models/S1.null.bm.rds")

S1.comp <- readRDS("../models/S1.comp.rds")
S1.weights <- readRDS("../models/S1.weights.rds")

### POSTERIOR PREDICTICE CHECKS
### Check plots ...they look good, as expected in binomial models
# pp_check(S1.full.bm)
# pp_check(S1.null.bm)
# pp_check(S1.full.bm, type = "bars")
# pp_check(S1.null.bm, type = "bars")

### EFFECTICE SAMPLE SIZES
### inspect rhat --> always 1 --> good
### inspect Bull_ESS --> always > 1000 --> good
# summary(S1.full.bm)
# summary(S1.null.bm)

# for reporting BULK_ESS and Coefficients
S1.full.coef <- summarise_draws(as_draws_df(S1.full.bm)) # ! standard is just 90% CrI

# NOTE: # as_draws_df() from posterior uses 90% CrIs
# we preregistered using 2.5% and 97.5% quantiles
draws_df <- as_draws_df(S1.full.bm)
quantiles_df <- as.data.frame(t(apply(draws_df, 2, quantile, probs = c(0.025, 0.975))))
quantiles_df <- tibble::rownames_to_column(quantiles_df, var = "variable")
names(quantiles_df)[2:3] <- c("q2.5", "q97.5")

S1.full.coef <- left_join(S1.full.coef, quantiles_df, by = "variable") 

# for table in appendix:
S1.full.coef.table <- S1.full.coef

# for reporting in text:
S1.full.coef <- S1.full.coef %>% 
  filter(grepl("^b_", variable)) %>% 
  mutate(variable = gsub("b_", "", variable)) %>% 
  mutate(variable = gsub("condition", "", variable)) %>% 
  data.frame(row.names = "variable")

S1.null.coef <- summarise_draws(as_draws_df(S1.null.bm)) %>%
  filter(grepl("^b_", variable))
# 
# mean(S1.full.coef$ess_bulk)
# min(S1.full.coef$ess_bulk)
# max(S1.full.coef$ess_bulk)
# 
# mean(S1.null.coef$ess_bulk)
# min(S1.null.coef$ess_bulk)
# max(S1.null.coef$ess_bulk)


```

# Additional Analyses including  item-level random effects

In addition to our main analyses, we preregistered an additional exploratory analyses for evaluating item-level effects separately in each study. For this we added a crossed random effect for items, allowing the relationship between age and performance to vary across items (correct \~ condition\*z.age + z.trial + sex + (z.trial \|subid)). Due to the lower number of individual items within a task, we expect this model to be less diagnostic with regard to our main research question. However, it adds detail about the equivalence of items within conditions.

## Study 1
An exploratory model with additional item-level random effects showed that the variability of intercepts at the item level was small ($\beta$ = `r S1.item.coef["sd_item__Intercept", "mean"]`, 95% CrI [`r S1.item.coef["sd_item__Intercept", "q2.5"]`,`r S1.item.coef["sd_item__Intercept", "q97.5"]`). Likewise there was only modest variation for the effect of age across items ($\beta$ = `r S1.item.coef["sd_item__z.age", "mean"]`, 95% CrI [`r S1.item.coef["sd_item__z.age", "q2.5"]`,`r S1.item.coef["sd_item__z.age", "q97.5"]`).The correlation between item difficulty and item-specific age slopes was highly uncertain (ρ = `r S1.item.coef["cor_item__Intercept__z.age", "mean"]`, 95% CrI [`r S1.item.coef["cor_item__Intercept__z.age", "q2.5"]`,`r S1.item.coef["cor_item__Intercept__z.age", "q97.5"]`). Model weights based on the WAIC suggested that the full model was more likely to provide accurate predictions (weight =  `r round(S1.itemvsfull.weights["S1.full.bm","value"]*100,2)`% ) compared to the item model (weight = `r round(S1.itemvsfull.weights["S1.item.model","value"]*100,2)`%).The estimated difference in expected log predictive density (elpd) between models, however, was not much larger than the difference itself  (ELPD diff = `r round(S1.itemvsfull.comp["S1.item.model", "elpd_diff"],2)`), indicating considerable uncertainty as to whether either model was preferable. For on overview of logg odds for all items across conditions see figure \@ref(fig:plot-study123itemintercepts). For a full overview of coefficients and the random effects structure of the item model see table \@ref(tab:S1item-coef-table). 

## Study 2
An exploratory model including item-level random effects indicated modest variability ($\beta$ = `r S2.item.coef["sd_item__Intercept", "mean"]`, 95% CrI [`r S2.item.coef["sd_item__Intercept", "q2.5"]`,`r S2.item.coef["sd_item__Intercept", "q97.5"]`). The variability of age effects across items was small ($\beta$ = `r S2.item.coef["sd_item__z.age", "mean"]`, 95% CrI [`r S2.item.coef["sd_item__z.age", "q2.5"]`, `r S2.item.coef["sd_item__z.age", "q97.5"]`), suggesting that the effect of age was fairly consistent across items. The correlation between item intercepts and age slopes was near zero and highly uncertain (ρ = `r S2.item.coef["cor_item__Intercept__z.age", "mean"]`, 95% CrI [`r S2.item.coef["cor_item__Intercept__z.age", "q2.5"]`,`r S2.item.coef["cor_item__Intercept__z.age", "q97.5"]`), providing no reliable evidence that slightly easier or difficult items varied in age-related gains. Comparing the models using WAIC weights showed that including item-level random effects in Study 2 did not provide a clear advantage in out-of-sample predictive accuracy (full model `r round(S2.itemvsfull.weights["S2.full.bm","value"]*100,2)`%; item model `r round(S2.itemvsfull.weights["S2.item.model","value"]*100,2)`%). Comparing the models corroborates this (ELPD WAIC; full model = `r round(S2.itemvsfull.comp["S2.full.bm", "elpd_waic"],2)`; item model = `r round(S2.itemvsfull.comp["S2.item.model", "elpd_waic"],2)`). The difference in expected log predictive density was negligible (ELPD diff = `r round(S2.itemvsfull.comp["S2.item.model", "elpd_diff"],2)`), and within the range of sampling uncertainty (SE =`r round(S2.itemvsfull.comp["S2.item.model", "se_diff"],2)`). For an overview of item level variability across conditions see figure \@ref(fig:plot-study123itemintercepts). For a full table of coefficients and random effects of the exploratory model see table \@ref(tab:S2item-coef-table).

## Study 3
To evaluate the equivalence of items within conditions, item-level random effects were included in an exploratory model showing that item variation at the intercept was moderate ($\beta$ = `r S3.item.coef["sd_item__Intercept", "mean"]`, 95% CrI [`r S3.item.coef["sd_item__Intercept", "q2.5"]`,`r S3.item.coef["sd_item__Intercept", "q97.5"]`) and that the effect of age varied slightly across items ($\beta$ = `r S3.item.coef["sd_item__z.age", "mean"]`, 95% CrI [`r S3.item.coef["sd_item__z.age", "q2.5"]`,`r S3.item.coef["sd_item__z.age", "q97.5"]`). Again, the correlation between item difficulty and item-specific age slopes was moderately positive but uncertain (ρ = `r S3.item.coef["cor_item__Intercept__z.age", "mean"]`, 95% CrI [`r S3.item.coef["cor_item__Intercept__z.age", "q2.5"]`,`r S3.item.coef["cor_item__Intercept__z.age", "q97.5"]`) providing weak evidence that easier items had stronger age-related gains. Comparing the models using WAIC weights showed that the item model had higher predictive power (full model `r round(S3.itemvsfull.weights["S3.full.bm","value"]*100,2)`%; item model `r round(S3.itemvsfull.weights["S3.item.model","value"]*100,2)`%). Comparing the models' WAIC via ELPDs corroborates this (full model = `r round(S3.itemvsfull.comp["S3.full.bm", "elpd_waic"],2)`; 
item model = `r round(S3.itemvsfull.comp["S3.item.model", "elpd_waic"],2)`). The difference in expected log predictive density favored the item model (ELPD diff = `r round(S3.itemvsfull.comp["S3.full.bm", "elpd_diff"],2)`), though the uncertainty around this estimate suggests that the evidence is not decisive (SE =`r round(S3.itemvsfull.comp["S3.full.bm", "se_diff"],2)`). Graphically exploring item-level variability via logg odds indicates that items are still very similar with their estimated deviation from the intercept still including zero (cf. figure \@ref(fig:plot-study123itemintercepts)). For an overview of coefficients and random effects see table \@ref(tab:S3item-coef-table) in appendix 3.

## Discussion
In studies 1 and 2, the inclusion of item-level random effects did not meaningfully improve model fit. The main analyses reported in the manuscript and the exploratory models reported here account for the data equally well. For study 3, including item-level random effects yielded moderate variability. Here the analysis provides modest evidence for variability due to item level effects. As in all studies reported above, these were small compared to the participant random effects. None of the model comparisons provided substantial evidence for a better fit of the exploratory models. Hence, the additional analyses provided here provide no grounds for deterring from the preregistered analysis reported in the manuscript.
\newpage

```{r S1item-coef-table, tab.cap = "Study 1 - Posterior Estimates for Exploratory Model with Item-Level Random Effects.", eval = T}

S1.item.coef.table.fin <- S1.item.coef.table %>% 
  slice(1:16) %>% 
  # filter(grepl("^b_", variable)) %>% 
  mutate(variable = gsub("b_", "", variable)) %>% 
  mutate(variable = gsub("condition", "", variable)) %>% 
  mutate(variable = gsub("([^ ])([A-Z])", "\\1 \\2", variable)) %>% 
  mutate(variable = gsub(":", " × ", variable)) %>% 
  mutate(variable = gsub("z.age", "Age*", variable)) %>% 
  mutate(variable = gsub("z.trial", "Trial*", variable)) %>% 
  mutate(variable = gsub("sex1", "Sex (Male)", variable)) %>%
  mutate(
    variable = gsub("sd_item__ Intercept", "Item Intercept (SD)", variable),
    variable = gsub("sd_item__Age\\*", "Item × Age Slope (SD)", variable),
    variable = gsub("sd_subid__ Intercept", "Subject Intercept (SD)", variable),
    variable = gsub("sd_subid__Trial\\*", "Subject × Trial slope (SD)", variable),
    variable = gsub("cor_item__ Intercept__Age\\*", "Correlation: Item Intercept & Age Slope", variable),
    variable = gsub("cor_subid__ Intercept__Trial\\*", "Correlation: Subject Intercept & Trial Slope", variable)) %>% 
  rename(
    Predictor = variable,
    Estimate = mean,
    SD = sd,
    MAD = mad,
    `2.5% CrI` = q2.5, 
    `97.5% CrI` = q97.5, 
    `Bulk ESS` = ess_bulk,
    `Tail ESS` = ess_tail) %>%
  mutate(
    `95% CrI` = paste0("[", sprintf("%.2f", `2.5% CrI`), ", ", sprintf("%.2f", `97.5% CrI`), "]"),
    `Bulk ESS` = format(round(`Bulk ESS`), big.mark = ","),
    `Tail ESS` = format(round(`Tail ESS`), big.mark = ",")) %>%
  select(Predictor, Estimate, SD, MAD, `95% CrI`, `Bulk ESS`, `Tail ESS`)

# add line to highlight the random effects section
S1.item.coef.table.fin <- bind_rows(
  S1.item.coef.table.fin[1:10, ],
  tibble(
    Predictor = "Random Effects",
    Estimate = NA_real_,
    SD = NA_real_,
    MAD = NA_real_,
    `95% CrI` = "",
    `Bulk ESS` = "",
    `Tail ESS` = ""
  ),
  S1.item.coef.table.fin[11:16, ]
)


# ft <- flextable(S1.item.coef.table.fin) %>%
#   theme_apa() %>%
#   set_caption("S1-item-table") %>%
#   fontsize(size = 8, part = "all") %>%
#   set_table_properties(layout = "autofit") %>%
#   add_footer_lines(values = "Note. Estimates represent posterior means with 95% equal-tailed credible intervals (CrIs). MAD indicates Median Absolute Deviation. ESS refers to effective sample size. R̂ values omitted as they are all ~1 indicating convergence.  * = variables were standardized.") %>%
#   fontsize(part = "footer", size = 8) %>%  
#   autofit()
# ft


ft <- flextable(S1.item.coef.table.fin) %>%
  theme_apa() %>%
  set_caption("S1item-coef-table") %>%
  fontsize(size = 8, part = "all") %>%
  set_table_properties(layout = "autofit") %>%
  add_footer_lines(values = "Note. Estimates represent posterior means with 95% equal-tailed credible intervals (CrIs). MAD indicates Median Absolute Deviation. ESS refers to effective sample size. R̂ values omitted as they are all ~1 indicating convergence.  * = variables were standardized.") %>%
  fontsize(part = "footer", size = 8) %>%
  bold(i = ~ Predictor == "Random effects", bold = TRUE, part = "body") %>% 
  merge_h(i = ~ Predictor == "Random effects") %>% # merge across columns
  autofit()

ft

```
\newpage

```{r S3item-coef-table, tab.cap = "Study 3 - Posterior Estimates for Exploratory Model with Item-Level Random Effects.", eval = T}



S3.item.coef.table.fin <- S3.item.coef.table %>% 
  slice(1:16) %>% 
  # filter(grepl("^b_", variable)) %>% 
  mutate(variable = gsub("b_", "", variable)) %>% 
  mutate(variable = gsub("condition", "", variable)) %>% 
  mutate(variable = gsub("([^ ])([A-Z])", "\\1 \\2", variable)) %>% 
  mutate(variable = gsub("of", " of", variable)) %>% 
  mutate(variable = gsub(":", " × ", variable)) %>% 
  mutate(variable = gsub("z.age", "Age*", variable)) %>% 
  mutate(variable = gsub("z.trial", "Trial*", variable)) %>% 
  mutate(variable = gsub("sex1", "Sex (Male)", variable)) %>%
  mutate(
    variable = gsub("sd_item__ Intercept", "Item Intercept (SD)", variable),
    variable = gsub("sd_item__Age\\*", "Item × Age Slope (SD)", variable),
    variable = gsub("sd_subid__ Intercept", "Subject Intercept (SD)", variable),
    variable = gsub("sd_subid__Trial\\*", "Subject × Trial slope (SD)", variable),
    variable = gsub("cor_item__ Intercept__Age\\*", "Correlation: Item Intercept & Age Slope", variable),
    variable = gsub("cor_subid__ Intercept__Trial\\*", "Correlation: Subject Intercept & Trial Slope", variable)) %>% 
  rename(
    Predictor = variable,
    Estimate = mean,
    SD = sd,
    MAD = mad,
    `2.5% CrI` = q2.5, 
    `97.5% CrI` = q97.5, 
    `Bulk ESS` = ess_bulk,
    `Tail ESS` = ess_tail) %>%
  mutate(
    `95% CrI` = paste0("[", sprintf("%.2f", `2.5% CrI`), ", ", sprintf("%.2f", `97.5% CrI`), "]"),
    `Bulk ESS` = format(round(`Bulk ESS`), big.mark = ","),
    `Tail ESS` = format(round(`Tail ESS`), big.mark = ",")) %>%
  select(Predictor, Estimate, SD, MAD, `95% CrI`, `Bulk ESS`, `Tail ESS`)

# add line to highlight the random effects section
S3.item.coef.table.fin <- bind_rows(
  S3.item.coef.table.fin[1:10, ],
  tibble(
    Predictor = "Random Effects",
    Estimate = NA_real_,
    SD = NA_real_,
    MAD = NA_real_,
    `95% CrI` = "",
    `Bulk ESS` = "",
    `Tail ESS` = ""
  ),
  S3.item.coef.table.fin[11:16, ]
)


ft <- flextable(S3.item.coef.table.fin) %>%
  theme_apa() %>%
  set_caption("S3-item-table") %>%
  fontsize(size = 8, part = "all") %>%
  set_table_properties(layout = "autofit") %>%
  add_footer_lines(values = "Note. Estimates represent posterior means with 95% equal-tailed credible intervals (CrIs). MAD indicates Median Absolute Deviation. ESS refers to effective sample size. R̂ values omitted as they are all ~1 indicating convergence.  * = variables were standardized.") %>%
  fontsize(part = "footer", size = 8) %>%
  bold(i = ~ Predictor == "Random effects", bold = TRUE, part = "body") %>% 
  merge_h(i = ~ Predictor == "Random effects") %>% # merge across columns
  autofit()

ft



```
\newpage

```{r S2item-coef-table, tab.cap = "Study 2 - Posterior Estimates for Exploratory Model with Item-Level Random Effects.", eval = T}



S2.item.coef.table.fin <- S2.item.coef.table %>% 
  slice(1:16) %>% 
  # filter(grepl("^b_", variable)) %>% 
  mutate(variable = gsub("b_", "", variable)) %>% 
  mutate(variable = gsub("condition", "", variable)) %>% 
  mutate(variable = gsub("([^ ])([A-Z])", "\\1 \\2", variable)) %>% 
  mutate(variable = gsub("of", " of", variable)) %>% 
  mutate(variable = gsub(":", " × ", variable)) %>% 
  mutate(variable = gsub("z.age", "Age*", variable)) %>% 
  mutate(variable = gsub("z.trial", "Trial*", variable)) %>% 
  mutate(variable = gsub("sex1", "Sex (Male)", variable)) %>%
  mutate(
    variable = gsub("sd_item__ Intercept", "Item Intercept (SD)", variable),
    variable = gsub("sd_item__Age\\*", "Item × Age Slope (SD)", variable),
    variable = gsub("sd_subid__ Intercept", "Subject Intercept (SD)", variable),
    variable = gsub("sd_subid__Trial\\*", "Subject × Trial slope (SD)", variable),
    variable = gsub("cor_item__ Intercept__Age\\*", "Correlation: Item Intercept & Age Slope", variable),
    variable = gsub("cor_subid__ Intercept__Trial\\*", "Correlation: Subject Intercept & Trial Slope", variable)) %>% 
  rename(
    Predictor = variable,
    Estimate = mean,
    SD = sd,
    MAD = mad,
    `2.5% CrI` = q2.5, 
    `97.5% CrI` = q97.5, 
    `Bulk ESS` = ess_bulk,
    `Tail ESS` = ess_tail) %>%
  mutate(
    `95% CrI` = paste0("[", sprintf("%.2f", `2.5% CrI`), ", ", sprintf("%.2f", `97.5% CrI`), "]"),
    `Bulk ESS` = format(round(`Bulk ESS`), big.mark = ","),
    `Tail ESS` = format(round(`Tail ESS`), big.mark = ",")) %>%
  select(Predictor, Estimate, SD, MAD, `95% CrI`, `Bulk ESS`, `Tail ESS`)

# add line to highlight the random effects section
S2.item.coef.table.fin <- bind_rows(
  S2.item.coef.table.fin[1:10, ],
  tibble(
    Predictor = "Random Effects",
    Estimate = NA_real_,
    SD = NA_real_,
    MAD = NA_real_,
    `95% CrI` = "",
    `Bulk ESS` = "",
    `Tail ESS` = ""
  ),
  S2.item.coef.table.fin[11:16, ]
)


ft <- flextable(S2.item.coef.table.fin) %>%
  theme_apa() %>%
  set_caption("S2-item-table") %>%
  fontsize(size = 8, part = "all") %>%
  set_table_properties(layout = "autofit") %>%
  add_footer_lines(values = "Note. Estimates represent posterior means with 95% equal-tailed credible intervals (CrIs). MAD indicates Median Absolute Deviation. ESS refers to effective sample size. R̂ values omitted as they are all ~1 indicating convergence.  * = variables were standardized.") %>%
  fontsize(part = "footer", size = 8) %>%
  bold(i = ~ Predictor == "Random effects", bold = TRUE, part = "body") %>% 
  merge_h(i = ~ Predictor == "Random effects") %>% # merge across columns
  autofit()

ft

```
\newpage

```{r plot-study123itemintercepts, fig.cap = "*Item-Level Random Intercepts by Condition.*", fig.align = "center", echo = FALSE, out.width = "96%"}

knitr::include_graphics(knitr::plot_crop("../illustrations/S1S2S3_item_plot.png"))

```


